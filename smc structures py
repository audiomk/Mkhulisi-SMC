// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © LudoGH68, PY
//@version=6
indicator("SMC Structures and Multi-Timeframe FVG MA PY", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500, max_bars_back=5000)
// ==========================================================================================
//                                     HELPER FUNCTIONS
// ==========================================================================================

// Helper to delete a line and its associated label
delete_line_and_label(line l, label la) =>
    if not na(l)
        l.delete()
    if not na(la)
        la.delete()

// Helper to get line style from string input
getLineStyle(string lineOption) =>
    switch lineOption
        "┈" => line.style_dotted
        "╌" => line.style_dashed
        => line.style_solid

// === Human Readable Timeframe Converter (Fixed for v6) ===
f_timeframeToLabel(tf) =>
    // Handle special cases first
    if tf == "D"
        "1D"
    else if tf == "W"
        "1W"
    else if tf == "M"
        "1M"
    else
        // Try to parse numeric values
        tfNum = str.tonumber(tf)
        if na(tfNum)
            tf // Return as-is if not numeric
        else if tfNum % 60 == 0
            str.tostring(tfNum / 60) + "H" // Convert minutes to hours
        else
            str.tostring(tfNum) // Keep minutes as-is

// ==========================================================================================
//                                     TYPE DEFINITIONS
// ==========================================================================================

// ==========================================================================================
//                                     USER INPUTS
// ==========================================================================================

//--------------------------------- FVG Settings -------------------------------------------//
string fvg_group = "Fair Value Gap (FVG) - Multi-Timeframe"
bool is_enable_fvg_section = input.bool(true, title='Enable FVGs Section', group=fvg_group, inline="fvg_main", display=display.none)

// FVG Colors
color bullishFvgColor = input.color(color.new(color.green, 60), 'Bullish Color', group=fvg_group, inline="fvg_colors", display=display.none, active=is_enable_fvg_section)
color bearishFvgColor = input.color(color.new(color.red, 60), 'Bearish Color', group=fvg_group, inline="fvg_colors", display=display.none, active=is_enable_fvg_section)
color mitigatedFvgColor = input.color(color.new(#8c8c8c, 70), 'Mitigated Color', group=fvg_group, inline="fvg_colors", display=display.none, active=is_enable_fvg_section)
color fvg_border_color_bull = input.color(color.new(color.green, 100), 'Bullish Border', group=fvg_group, inline="fvg_border", display=display.none, active=is_enable_fvg_section)
color fvg_border_color_bear = input.color(color.new(color.red, 100), 'Bearish Border', group=fvg_group, inline="fvg_border", display=display.none, active=is_enable_fvg_section)

bool isMitigatedFvgToReduce = input.bool(true, title='Reduce Mitigated FVG Area', group=fvg_group, active=is_enable_fvg_section)
label_size = input.string(size.small, "FVGs Labels size", [size.tiny, size.small, size.normal, size.large, size.huge], group = fvg_group, display=display.none, active=is_enable_fvg_section)
int fvgTFDistance = input.int(10, 'FVGs Timeframe Distance', minval=1, maxval=25, group=fvg_group, tooltip="Controls how many candles on the right side between a timeframe FVG and one higher timeframe FVG.", active=is_enable_fvg_section)
bool ltf_hide = input.bool(true, "Hide FVG's lowers than enabled timeframes?", group=fvg_group, display=display.none, active=is_enable_fvg_section)
bool isAddBarIndex = input.bool(false, "Show FVG BarIndex?", group=fvg_group, display=display.none, active=is_enable_fvg_section)
int fvgHistoryNbr = input.int(8, 'Global Max Active FVGs per Timeframe', minval=1, maxval=50, group=fvg_group, tooltip="Sets the global upper limit for the number of active FVGs per timeframe. Each timeframe's Max FVGs (e.g., TF1 Max FVGs, TF2 Max FVGs) cannot exceed this value and will be capped at this limit if a higher number is entered.", active=is_enable_fvg_section)

// Warning text as pure text above fvgHistoryNbr using input.bool with display=none
//bool fvg_limit_warning_text = input.bool(false, title="All timeframe Max FVGs (e.g., TF1 Max FVGs, TF2 Max FVGs) are capped at the global upper limit below.", group=fvg_group, tooltip="This is a note: Each timeframe's Max FVGs cannot exceed the Max Active FVGs value and will be capped if higher.", display=display.none)
bool tf1_show = input.bool(true, "TF1", group = fvg_group, inline="tf1", display=display.none, active=is_enable_fvg_section)
string tf1 = input.timeframe("15", "", group=fvg_group, inline="tf1", display=display.none, active=is_enable_fvg_section)
string tf1_label = input.string("15", "", group=fvg_group, inline="tf1", display=display.none, active=is_enable_fvg_section)
int tf1_fvg_limit = input.int(6, "TF1 Max FVGs", minval=1, maxval=50, group=fvg_group, inline="tf1", display=display.none, active=is_enable_fvg_section)

bool tf2_show = input.bool(true, "TF2", group = fvg_group, inline="tf2", display=display.none, active=is_enable_fvg_section)
string tf2 = input.timeframe("60", "", group=fvg_group, inline="tf2", display=display.none, active=is_enable_fvg_section)
string tf2_label = input.string("1H", "", group=fvg_group, inline="tf2", display=display.none, active=is_enable_fvg_section)
int tf2_fvg_limit = input.int(4, "TF2 Max FVGs", minval=1, maxval=50, group=fvg_group, inline="tf2", display=display.none, active=is_enable_fvg_section)

bool tf3_show = input.bool(true, "TF3", group = fvg_group, inline="tf3", display=display.none, active=is_enable_fvg_section)
string tf3 = input.timeframe("240", "", group=fvg_group, inline="tf3", display=display.none, active=is_enable_fvg_section)
string tf3_label = input.string("4H", "", group=fvg_group, inline="tf3", display=display.none, active=is_enable_fvg_section)
int tf3_fvg_limit = input.int(4, "TF3 Max FVGs", minval=1, maxval=50, group=fvg_group, inline="tf3", display=display.none, active=is_enable_fvg_section)

bool tf4_show = input.bool(true, "TF4", group = fvg_group, inline="tf4", display=display.none, active=is_enable_fvg_section)
string tf4 = input.timeframe("D", "", group=fvg_group, inline="tf4", display=display.none, active=is_enable_fvg_section)
string tf4_label = input.string("1D", "", group=fvg_group, inline="tf4", display=display.none, active=is_enable_fvg_section)
int tf4_fvg_limit = input.int(4, "TF4 Max FVGs", minval=1, maxval=50, group=fvg_group, inline="tf4", display=display.none, active=is_enable_fvg_section)

bool tf5_show = input.bool(false, "TF5", group = fvg_group, inline="tf5", display=display.none, active=is_enable_fvg_section)
string tf5 = input.timeframe("W", "", group=fvg_group, inline="tf5", display=display.none, active=is_enable_fvg_section)
string tf5_label = input.string("1W", "", group=fvg_group, inline="tf5", display=display.none, active=is_enable_fvg_section)
int tf5_fvg_limit = input.int(4, "TF5 Max FVGs", minval=1, maxval=50, group=fvg_group, inline="tf5", display=display.none, active=is_enable_fvg_section)

bool tf6_show = input.bool(false, "TF6", group = fvg_group, inline="tf6", display=display.none, active=is_enable_fvg_section)
string tf6 = input.timeframe("1M", "", group=fvg_group, inline="tf6", display=display.none, active=is_enable_fvg_section)
string tf6_label = input.string("1M", "", group=fvg_group, inline="tf6", display=display.none, active=is_enable_fvg_section)
int tf6_fvg_limit = input.int(4, "TF6 Max FVGs", minval=1, maxval=50, group=fvg_group, inline="tf6", display=display.none, active=is_enable_fvg_section)

bool tf7_show = input.bool(false, "TF7", group = fvg_group, inline="tf7", display=display.none, active=is_enable_fvg_section)
string tf7 = input.timeframe("6M", "", group=fvg_group, inline="tf7", display=display.none, active=is_enable_fvg_section)
string tf7_label = input.string("6M", "", group=fvg_group, inline="tf7", display=display.none, active=is_enable_fvg_section)
int tf7_fvg_limit = input.int(4, "TF7 Max FVGs", minval=1, maxval=50, group=fvg_group, inline="tf7", display=display.none, active=is_enable_fvg_section)

bool tf8_show = input.bool(false, "TF8", group = fvg_group, inline="tf8", display=display.none, active=is_enable_fvg_section)
string tf8 = input.timeframe("12M", "", group=fvg_group, inline="tf8", display=display.none, active=is_enable_fvg_section)
string tf8_label = input.string("12M", "", group=fvg_group, inline="tf8", display=display.none, active=is_enable_fvg_section)
int tf8_fvg_limit = input.int(4, "TF8 Max FVGs", minval=1, maxval=50, group=fvg_group, inline="tf8", display=display.none, active=is_enable_fvg_section)

//--------------------------------- Moving Average Settings --------------------------------//
string ma_group='Moving Average - Multi-TimeFrame'
string ma_help = "Width,Transparency,LineStyle,Color"
bool is_enable_ma_section = input.bool(true, "Enable MA Section", group = ma_group, display=display.none, tooltip = "If you choose 1W MA, the end of the curve is at the last close of weekly. If you choose 1D MA, the end of the curve is at the last close of daily. You can find it, and it may be out of your current viewing area.")
string inputTemplate = input.string(title='Template', group=ma_group, defval='DISABLED', options=['DISABLED', 'EMA 20-50-100-200', 'EMA Fibonacci 21-55-89-144-233', 'EMA 20-50-100-200 / SMA 100-200', 'EMA Golden/Death Cross 50-200', 'SMA Golden/Death Cross 50-200', 'SMA 5-10-20-50-200', 'HMA Cross 21-34','The Crypto School Long Short Trading'], tooltip = "Choose templates here to override all MA settings below.", display=display.none, active = is_enable_ma_section)
bool ma_setting_active = (inputTemplate == "DISABLED") and is_enable_ma_section
input_template_Timeframe = input.timeframe(title="Template Timeframe", group=ma_group, defval="", tooltip = "Use one timeframe only when using a template.", display=display.none, active = not(ma_setting_active) and is_enable_ma_section)

bool input_1_showMA = input.bool(true, 'MA 1 Show', group=ma_group, inline = "MA Curve Show1", display=display.none, active = is_enable_ma_section)
bool input_2_showMA = input.bool(true, 'MA 2 Show', group=ma_group, inline = "MA Curve Show1", display=display.none, active = is_enable_ma_section)
bool input_3_showMA = input.bool(true, 'MA 3 Show', group=ma_group, inline = "MA Curve Show1", display=display.none, active = is_enable_ma_section)
bool input_4_showMA = input.bool(true, 'MA 4 Show', group=ma_group, inline = "MA Curve Show1", display=display.none, active = is_enable_ma_section)
bool input_5_showMA = input.bool(true, 'MA 5 Show', group=ma_group, inline = "MA Curve Show1", display=display.none, active = is_enable_ma_section)
bool input_6_showMA = input.bool(true, 'MA 6 Show', group=ma_group, inline = "MA Curve Show2", display=display.none, active = is_enable_ma_section)
bool input_7_showMA = input.bool(true, 'MA 7 Show', group=ma_group, inline = "MA Curve Show2", display=display.none, active = is_enable_ma_section)
bool input_8_showMA = input.bool(true, 'MA 8 Show', group=ma_group, inline = "MA Curve Show2", display=display.none, active = is_enable_ma_section)
bool input_9_showMA = input.bool(true, 'MA 9 Show', group=ma_group, inline = "MA Curve Show2", display=display.none, active = is_enable_ma_section)
bool input_10_showMA = input.bool(true, 'MA 10 Show', group=ma_group, inline = "MA Curve Show2", display=display.none, active = is_enable_ma_section)

bool input_1_showLabel = input.bool(true, 'MA 1 Label', group=ma_group, inline = "MA Curve Label1", display=display.none, active = is_enable_ma_section)
bool input_2_showLabel = input.bool(true, 'MA 2 Label', group=ma_group, inline = "MA Curve Label1", display=display.none, active = is_enable_ma_section)
bool input_3_showLabel = input.bool(true, 'MA 3 Label', group=ma_group, inline = "MA Curve Label1", display=display.none, active = is_enable_ma_section)
bool input_4_showLabel = input.bool(true, 'MA 4 Label', group=ma_group, inline = "MA Curve Label1", display=display.none, active = is_enable_ma_section)
bool input_5_showLabel = input.bool(true, 'MA 5 Label', group=ma_group, inline = "MA Curve Label1", display=display.none, active = is_enable_ma_section)
bool input_6_showLabel = input.bool(true, 'MA 6 Label', group=ma_group, inline = "MA Curve Label2", display=display.none, active = is_enable_ma_section)
bool input_7_showLabel = input.bool(true, 'MA 7 Label', group=ma_group, inline = "MA Curve Label2", display=display.none, active = is_enable_ma_section)
bool input_8_showLabel = input.bool(true, 'MA 8 Label', group=ma_group, inline = "MA Curve Label2", display=display.none, active = is_enable_ma_section)
bool input_9_showLabel = input.bool(true, 'MA 9 Label', group=ma_group, inline = "MA Curve Label2", display=display.none, active = is_enable_ma_section)
bool input_10_showLabel = input.bool(true, 'MA 10 Label', group=ma_group, inline = "MA Curve Label2", display=display.none, active = is_enable_ma_section)
color input_curve_label_color = input(title='MA Curve Label Color', group=ma_group, inline = "MA Label Style", defval=#FFFFFF, display=display.none, active = is_enable_ma_section)
input_curve_label_size = input.string(size.tiny, "MA Curve Label size", [size.tiny, size.small, size.normal, size.large, size.huge], group = ma_group, inline = "MA Label Style", display=display.none, active = is_enable_ma_section)
int input_curve_label_transp = input.int(title='MA Curve Label Transparency', group=ma_group, inline = "MA Label Style", minval=0, maxval=100, defval=30, step=5, display=display.none, active = is_enable_ma_section)

string input_1_MaType = input.string(title='MA 1', group=ma_group, inline = "MA 1", defval='DISABLED', options=['DISABLED', 'COVWMA', 'DEMA', 'EMA', 'EHMA', 'FRAMA', 'HMA', 'KAMA', 'SMA', 'SMMA (RMA)', 'TEMA', 'VIDYA', 'VWMA', 'WMA'], display=display.none, active = ma_setting_active)
int input_1_MaLength = input.int(title='', group=ma_group, inline = "MA 1", minval=1, maxval=1000, defval=20, display=display.none, active = ma_setting_active)
input_1_Timeframe = input.timeframe(title="", group=ma_group, inline = "MA 1", defval="", display=display.none, active = ma_setting_active)
input_1_Source = input(title='', group=ma_group, inline = "MA 1", defval=close, display=display.none, active = ma_setting_active)
int input_1_LineWidth = input.int(title='Style:', group=ma_group, inline = "MA 1a", minval=1, maxval=4, defval=2, step=1, display=display.none, active = ma_setting_active)
int input_1_LineTransparency = input.int(title='', group=ma_group, inline = "MA 1a", minval=0, maxval=100, defval=0, step=5, display=display.none, active = ma_setting_active)
string input_1_LineStyle = input.string(title='', group=ma_group, inline = "MA 1a", defval='Line', options=['Line', 'Stepline', 'Step Line With Diamonds', 'Circles'], tooltip = ma_help, display=display.none, active = ma_setting_active)
color input_1_color = input.color(title='', group=ma_group, inline = "MA 1a", defval=#0D47A1, display=display.none, active = ma_setting_active)

string input_2_MaType = input.string(title='MA 2', group=ma_group, inline = "MA 2", defval='DISABLED', options=['DISABLED', 'COVWMA', 'DEMA', 'EMA', 'EHMA', 'FRAMA', 'HMA', 'KAMA', 'SMA', 'SMMA (RMA)', 'TEMA', 'VIDYA', 'VWMA', 'WMA'], display=display.none, active = ma_setting_active)
int input_2_MaLength = input.int(title='', group=ma_group, inline = "MA 2", minval=1, maxval=1000, defval=20, display=display.none, active = ma_setting_active)
input_2_Timeframe = input.timeframe(title="", group=ma_group, inline = "MA 2", defval="", display=display.none, active = ma_setting_active)
input_2_Source = input(title='', group=ma_group, inline = "MA 2", defval=close, display=display.none, active = ma_setting_active)
int input_2_LineWidth = input.int(title='Style:', group=ma_group, inline = "MA 2a", minval=1, maxval=4, defval=2, step=1, display=display.none, active = ma_setting_active)
int input_2_LineTransparency = input.int(title='', group=ma_group, inline = "MA 2a", minval=0, maxval=100, defval=0, step=5, display=display.none, active = ma_setting_active)
string input_2_LineStyle = input.string(title='', group=ma_group, inline = "MA 2a", defval='Line', options=['Line', 'Stepline', 'Step Line With Diamonds', 'Circles'], tooltip = ma_help, display=display.none, active = ma_setting_active)
color input_2_color = input(title='', group=ma_group, inline = "MA 2a", defval=#B71C1C, display=display.none, active = ma_setting_active)

string input_3_MaType = input.string(title='MA 3', group=ma_group, inline = "MA 3", defval='DISABLED', options=['DISABLED', 'COVWMA', 'DEMA', 'EMA', 'EHMA', 'FRAMA', 'HMA', 'KAMA', 'SMA', 'SMMA (RMA)', 'TEMA', 'VIDYA', 'VWMA', 'WMA'], display=display.none, active = ma_setting_active)
int input_3_MaLength = input.int(title='', group=ma_group, inline = "MA 3", minval=1, maxval=1000, defval=20, display=display.none, active = ma_setting_active)
input_3_Timeframe = input.timeframe(title="", group=ma_group, inline = "MA 3", defval="", display=display.none, active = ma_setting_active)
input_3_Source = input(title='', group=ma_group, inline = "MA 3", defval=close, display=display.none, active = ma_setting_active)
int input_3_LineWidth = input.int(title='Style:', group=ma_group, inline = "MA 3a", minval=1, maxval=4, defval=2, step=1, display=display.none, active = ma_setting_active)
int input_3_LineTransparency = input.int(title='', group=ma_group, inline = "MA 3a", minval=0, maxval=100, defval=0, step=5, display=display.none, active = ma_setting_active)
string input_3_LineStyle = input.string(title='', group=ma_group, inline = "MA 3a", defval='Line', options=['Line', 'Stepline', 'Step Line With Diamonds', 'Circles'], tooltip = ma_help, display=display.none, active = ma_setting_active)
color input_3_color = input(title='', group=ma_group, inline = "MA 3a", defval=#4A148C, display=display.none, active = ma_setting_active)

string input_4_MaType = input.string(title='MA 4', group=ma_group, inline = "MA 4", defval='DISABLED', options=['DISABLED', 'COVWMA', 'DEMA', 'EMA', 'EHMA', 'FRAMA', 'HMA', 'KAMA', 'SMA', 'SMMA (RMA)', 'TEMA', 'VIDYA', 'VWMA', 'WMA'], display=display.none, active = ma_setting_active)
int input_4_MaLength = input.int(title='', group=ma_group, inline = "MA 4", minval=1, maxval=1000, defval=20, display=display.none, active = ma_setting_active)
input_4_Timeframe = input.timeframe(title="", group=ma_group, inline = "MA 4", defval="", display=display.none, active = ma_setting_active)
input_4_Source = input(title='', group=ma_group, inline = "MA 4", defval=close, display=display.none, active = ma_setting_active)
int input_4_LineWidth = input.int(title='Style:', group=ma_group, inline = "MA 4a", minval=1, maxval=4, defval=2, step=1, display=display.none, active = ma_setting_active)
int input_4_LineTransparency = input.int(title='', group=ma_group, inline = "MA 4a", minval=0, maxval=100, defval=0, step=5, display=display.none, active = ma_setting_active)
string input_4_LineStyle = input.string(title='', group=ma_group, inline = "MA 4a", defval='Line', options=['Line', 'Stepline', 'Step Line With Diamonds', 'Circles'], tooltip = ma_help, display=display.none, active = ma_setting_active)
color input_4_color = input(title='', group=ma_group, inline = "MA 4a", defval=#EEEEEE, display=display.none, active = ma_setting_active)

string input_5_MaType = input.string(title='MA 5', group=ma_group, inline = "MA 5", defval='DISABLED', options=['DISABLED', 'COVWMA', 'DEMA', 'EMA', 'EHMA', 'FRAMA', 'HMA', 'KAMA', 'SMA', 'SMMA (RMA)', 'TEMA', 'VIDYA', 'VWMA', 'WMA'], display=display.none, active = ma_setting_active)
int input_5_MaLength = input.int(title='', group=ma_group, inline = "MA 5", minval=1, maxval=1000, defval=20, display=display.none, active = ma_setting_active)
input_5_Timeframe = input.timeframe(title="", group=ma_group, inline = "MA 5", defval="", display=display.none, active = ma_setting_active)
input_5_Source = input(title='', group=ma_group, inline = "MA 5", defval=close, display=display.none, active = ma_setting_active)
int input_5_LineWidth = input.int(title='Style:', group=ma_group, inline = "MA 5a", minval=1, maxval=4, defval=2, step=1, display=display.none, active = ma_setting_active)
int input_5_LineTransparency = input.int(title='', group=ma_group, inline = "MA 5a", minval=0, maxval=100, defval=0, step=5, display=display.none, active = ma_setting_active)
string input_5_LineStyle = input.string(title='', group=ma_group, inline = "MA 5a", defval='Line', options=['Line', 'Stepline', 'Step Line With Diamonds', 'Circles'], tooltip = ma_help, display=display.none, active = ma_setting_active)
color input_5_color = input(title='', group=ma_group, inline = "MA 5a", defval=#FFCA28, display=display.none, active = ma_setting_active)

string input_6_MaType = input.string(title='MA 6', group=ma_group, inline = "MA 6", defval='DISABLED', options=['DISABLED', 'COVWMA', 'DEMA', 'EMA', 'EHMA', 'FRAMA', 'HMA', 'KAMA', 'SMA', 'SMMA (RMA)', 'TEMA', 'VIDYA', 'VWMA', 'WMA'], display=display.none, active = ma_setting_active)
int input_6_MaLength = input.int(title='', group=ma_group, inline = "MA 6", minval=1, maxval=1000, defval=20, display=display.none, active = ma_setting_active)
input_6_Timeframe = input.timeframe(title="", group=ma_group, inline = "MA 6", defval="", display=display.none, active = ma_setting_active)
input_6_Source = input(title='', group=ma_group, inline = "MA 6", defval=close, display=display.none, active = ma_setting_active)
int input_6_LineWidth = input.int(title='Style:', group=ma_group, inline = "MA 6a", minval=1, maxval=4, defval=2, step=1, display=display.none, active = ma_setting_active)
int input_6_LineTransparency = input.int(title='', group=ma_group, inline = "MA 6a", minval=0, maxval=100, defval=0, step=5, display=display.none, active = ma_setting_active)
string input_6_LineStyle = input.string(title='', group=ma_group, inline = "MA 6a", defval='Line', options=['Line', 'Stepline', 'Step Line With Diamonds', 'Circles'], tooltip = ma_help, display=display.none, active = ma_setting_active)
color input_6_color = input(title='', group=ma_group, inline = "MA 6a", defval=#1B5E20, display=display.none, active = ma_setting_active)

string input_7_MaType = input.string(title='MA 7', group=ma_group, inline = "MA 7", defval='DISABLED', options=['DISABLED', 'COVWMA', 'DEMA', 'EMA', 'EHMA', 'FRAMA', 'HMA', 'KAMA', 'SMA', 'SMMA (RMA)', 'TEMA', 'VIDYA', 'VWMA', 'WMA'], display=display.none, active = ma_setting_active)
int input_7_MaLength = input.int(title='', group=ma_group, inline = "MA 7", minval=1, maxval=1000, defval=20, display=display.none, active = ma_setting_active)
input_7_Timeframe = input.timeframe(title="", group=ma_group, inline = "MA 7", defval="", display=display.none, active = ma_setting_active)
input_7_Source = input(title='', group=ma_group, inline = "MA 7", defval=close, display=display.none, active = ma_setting_active)
int input_7_LineWidth = input.int(title='Style:', group=ma_group, inline = "MA 7a", minval=1, maxval=4, defval=2, step=1, display=display.none, active = ma_setting_active)
int input_7_LineTransparency = input.int(title='', group=ma_group, inline = "MA 7a", minval=0, maxval=100, defval=0, step=5, display=display.none, active = ma_setting_active)
string input_7_LineStyle = input.string(title='', group=ma_group, inline = "MA 7a", defval='Line', options=['Line', 'Stepline', 'Step Line With Diamonds', 'Circles'], tooltip = ma_help, display=display.none, active = ma_setting_active)
color input_7_color = input(title='', group=ma_group, inline = "MA 7a", defval=#AD1457, display=display.none, active = ma_setting_active)

string input_8_MaType = input.string(title='MA 8', group=ma_group, inline = "MA 8", defval='DISABLED', options=['DISABLED', 'COVWMA', 'DEMA', 'EMA', 'EHMA', 'FRAMA', 'HMA', 'KAMA', 'SMA', 'SMMA (RMA)', 'TEMA', 'VIDYA', 'VWMA', 'WMA'], display=display.none, active = ma_setting_active)
int input_8_MaLength = input.int(title='', group=ma_group, inline = "MA 8", minval=1, maxval=1000, defval=20, display=display.none, active = ma_setting_active)
input_8_Timeframe = input.timeframe(title="", group=ma_group, inline = "MA 8", defval="", display=display.none, active = ma_setting_active)
input_8_Source = input(title='', group=ma_group, inline = "MA 8", defval=close, display=display.none, active = ma_setting_active)
int input_8_LineWidth = input.int(title='Style:', group=ma_group, inline = "MA 8a", minval=1, maxval=4, defval=2, step=1, display=display.none, active = ma_setting_active)
int input_8_LineTransparency = input.int(title='', group=ma_group, inline = "MA 8a", minval=0, maxval=100, defval=0, step=5, display=display.none, active = ma_setting_active)
string input_8_LineStyle = input.string(title='', group=ma_group, inline = "MA 8a", defval='Line', options=['Line', 'Stepline', 'Step Line With Diamonds', 'Circles'], tooltip = ma_help, display=display.none, active = ma_setting_active)
color input_8_color = input(title='', group=ma_group, inline = "MA 8a", defval=#006064, display=display.none, active = ma_setting_active)

string input_9_MaType = input.string(title='MA 9', group=ma_group, inline = "MA 9", defval='DISABLED', options=['DISABLED', 'COVWMA', 'DEMA', 'EMA', 'EHMA', 'FRAMA', 'HMA', 'KAMA', 'SMA', 'SMMA (RMA)', 'TEMA', 'VIDYA', 'VWMA', 'WMA'], display=display.none, active = ma_setting_active)
int input_9_MaLength = input.int(title='', group=ma_group, inline = "MA 9", minval=1, maxval=1000, defval=20, display=display.none, active = ma_setting_active)
input_9_Timeframe = input.timeframe(title="", group=ma_group, inline = "MA 9", defval="", display=display.none, active = ma_setting_active)
input_9_Source = input(title='', group=ma_group, inline = "MA 9", defval=close, display=display.none, active = ma_setting_active)
int input_9_LineWidth = input.int(title='Style:', group=ma_group, inline = "MA 9a", minval=1, maxval=4, defval=2, step=1, display=display.none, active = ma_setting_active)
int input_9_LineTransparency = input.int(title='', group=ma_group, inline = "MA 9a", minval=0, maxval=100, defval=0, step=5, display=display.none, active = ma_setting_active)
string input_9_LineStyle = input.string(title='', group=ma_group, inline = "MA 9a", defval='Line', options=['Line', 'Stepline', 'Step Line With Diamonds', 'Circles'], tooltip = ma_help, display=display.none, active = ma_setting_active)
color input_9_color = input(title='', group=ma_group, inline = "MA 9a", defval=#1DE9B6, display=display.none, active = ma_setting_active)

string input_10_MaType = input.string(title='MA10', group=ma_group, inline = "MA 10", defval='DISABLED', options=['DISABLED', 'COVWMA', 'DEMA', 'EMA', 'EHMA', 'FRAMA', 'HMA', 'KAMA', 'SMA', 'SMMA (RMA)', 'TEMA', 'VIDYA', 'VWMA', 'WMA'], display=display.none, active = ma_setting_active)
int input_10_MaLength = input.int(title='', group=ma_group, inline = "MA 10", minval=1, maxval=1000, defval=20, display=display.none, active = ma_setting_active)
input_10_Timeframe = input.timeframe(title="", group=ma_group, inline = "MA 10", defval="", display=display.none, active = ma_setting_active)
input_10_Source = input(title='', group=ma_group, inline = "MA 10", defval=close, display=display.none, active = ma_setting_active)
int input_10_LineWidth = input.int(title='Style:', group=ma_group, inline = "MA 10a", minval=1, maxval=4, defval=2, step=1, display=display.none, active = ma_setting_active)
int input_10_LineTransparency = input.int(title='', group=ma_group, inline = "MA 10a", minval=0, maxval=100, defval=0, step=5, display=display.none, active = ma_setting_active)
string input_10_LineStyle = input.string(title='', group=ma_group, inline = "MA 10a", defval='Line', options=['Line', 'Stepline', 'Step Line With Diamonds', 'Circles'], tooltip = ma_help, display=display.none, active = ma_setting_active)
color input_10_color = input(title='', group=ma_group, inline = "MA 10a", defval=#00E5FF, display=display.none, active = ma_setting_active)

//--------------------------------- Structure Settings -------------------------------------//
string structures_group = "Structures (BOS/CHoCH) - Current Timeframe"
bool is_enable_BosChoch_section = input.bool(true, title='Enable BOS/CHoCH Section', group=structures_group, display=display.none)
bool is_enable_currentstruct_section = input.bool(true, title='Enable Current Structure Section', group=structures_group, display=display.none)
bool isStructBodyCandleBreak = input.bool(true, title='Break with Candle\'s Body', group=structures_group, display=display.none)

color bullishBosColor = input.color(color.silver, 'Bullish BOS Color', group=structures_group, inline="BOS", display=display.none, active=is_enable_BosChoch_section)
color bearishBosColor = input.color(color.silver, 'Bearish BOS Color', group=structures_group, inline="BOS", display=display.none, active=is_enable_BosChoch_section)
string bosLineStyleOption = input.string("─", title="BOS Style", group=structures_group, options=["─", "┈", "╌"], inline="BOS2", display=display.none, active=is_enable_BosChoch_section)
bosLineStyle = getLineStyle(bosLineStyleOption)
int bosLineWidth = input.int(1, title="BOS Width", group=structures_group, minval=1, maxval=5, inline="BOS2", display=display.none, active=is_enable_BosChoch_section)

color bullishChochColor = input.color(color.yellow, 'Bullish CHoCH Color', group=structures_group, inline="CHoCH", display=display.none, active=is_enable_BosChoch_section)
color bearishChochColor = input.color(color.yellow, 'Bearish CHoCH Color', group=structures_group, inline="CHoCH", display=display.none, active=is_enable_BosChoch_section)
string chochLineStyleOption = input.string("─", title="CHoCH Style", group=structures_group, options=["─", "┈", "╌"], inline="CHoCH2", display=display.none, active=is_enable_BosChoch_section)
chochLineStyle = getLineStyle(chochLineStyleOption)
int chochLineWidth = input.int(1, title="CHoCH Width", group=structures_group, minval=1, maxval=5, inline="CHoCH2", display=display.none, active=is_enable_BosChoch_section)

color currentStructColor = input.color(color.blue, 'Current structure Color', group=structures_group, display=display.none, active = is_enable_currentstruct_section)
string currentStructLineStyleOption = input.string("─", title="Current structure Style", group=structures_group, options=["─", "┈", "╌"], display=display.none, active = is_enable_currentstruct_section)
currentStructLineStyle = getLineStyle(currentStructLineStyleOption)
int currentStructLineWidth = input.int(1, title="Current structure Width", group=structures_group, minval=1, maxval=5, display=display.none, active = is_enable_currentstruct_section)
int structHistoryNbr = input.int(10, 'Number of Breaks to Show', minval=1, maxval=50, group=structures_group, display=display.none, active = is_enable_currentstruct_section)

//--------------------------------- Fibonacci Settings -------------------------------------//
string fibo_group = "Structure Fibonacci"
bool is_enable_structfib_section = input.bool(false, title='Enable Structure Fibonacci Section', group=fibo_group, display=display.none)

bool isFibo1ToShow = input.bool(true, title = "", group=fibo_group, inline = "Fibo1", display=display.none, active = is_enable_structfib_section)
float fibo1Value = input.float(0.786, title = "", group=fibo_group, inline = "Fibo1", display=display.none, active = isFibo1ToShow and is_enable_structfib_section)
color fibo1Color = input.color(#64b5f6, title = "", group=fibo_group, inline = "Fibo1", display=display.none, active = isFibo1ToShow and is_enable_structfib_section)
string fibo1StyleOption = input.string("─", title = "", group=fibo_group, options=["─", "┈", "╌"], inline = "Fibo1", display=display.none, active = isFibo1ToShow and is_enable_structfib_section)
int fibo1LineWidth = input.int(1, title = "", group=fibo_group, minval=1, maxval=5, inline = "Fibo1", display=display.none, active = isFibo1ToShow and is_enable_structfib_section)

bool isFibo2ToShow = input.bool(true, title = "", group=fibo_group, inline = "Fibo2", display=display.none, active = is_enable_structfib_section)
float fibo2Value = input.float(0.705, title = "", group=fibo_group, inline = "Fibo2", display=display.none, active = isFibo2ToShow and is_enable_structfib_section)
color fibo2Color = input.color(#f23645, title = "", group=fibo_group, inline = "Fibo2", display=display.none, active = isFibo2ToShow and is_enable_structfib_section)
string fibo2StyleOption = input.string("─", title = "", group=fibo_group, options=["─", "┈", "╌"], inline = "Fibo2", display=display.none, active = isFibo2ToShow and is_enable_structfib_section)
int fibo2LineWidth = input.int(1, title = "", group=fibo_group, minval=1, maxval=5, inline = "Fibo2", display=display.none, active = isFibo2ToShow and is_enable_structfib_section)

bool isFibo3ToShow = input.bool(true, title = "", group=fibo_group, inline = "Fibo3", display=display.none, active = is_enable_structfib_section)
float fibo3Value = input.float(0.618, title = "", group=fibo_group, inline = "Fibo3", display=display.none, active = isFibo3ToShow and is_enable_structfib_section)
color fibo3Color = input.color(#089981, title = "", group=fibo_group, inline = "Fibo3", display=display.none, active = isFibo3ToShow and is_enable_structfib_section)
string fibo3StyleOption = input.string("─", title = "", group=fibo_group, options=["─", "┈", "╌"], inline = "Fibo3", display=display.none, active = isFibo3ToShow and is_enable_structfib_section)
int fibo3LineWidth = input.int(1, title = "", group=fibo_group, minval=1, maxval=5, inline = "Fibo3", display=display.none, active = isFibo3ToShow and is_enable_structfib_section)

bool isFibo4ToShow = input.bool(true, title = "", group=fibo_group, inline = "Fibo4", display=display.none, active = is_enable_structfib_section)
float fibo4Value = input.float(0.5, title = "", group=fibo_group, inline = "Fibo4", display=display.none, active = isFibo4ToShow and is_enable_structfib_section)
color fibo4Color = input.color(#4caf50, title = "", group=fibo_group, inline = "Fibo4", display=display.none, active = isFibo4ToShow and is_enable_structfib_section)
string fibo4StyleOption = input.string("─", title = "", group=fibo_group, options=["─", "┈", "╌"], inline = "Fibo4", display=display.none, active = isFibo4ToShow and is_enable_structfib_section)
int fibo4LineWidth = input.int(1, title = "", group=fibo_group, minval=1, maxval=5, inline = "Fibo4", display=display.none, active = isFibo4ToShow and is_enable_structfib_section)

bool isFibo5ToShow = input.bool(true, title = "", group=fibo_group, inline = "Fibo5", display=display.none, active = is_enable_structfib_section)
float fibo5Value = input.float(0.382, title = "", group=fibo_group, inline = "Fibo5", display=display.none, active = isFibo5ToShow and is_enable_structfib_section)
color fibo5Color = input.color(#81c784, title = "", group=fibo_group, inline = "Fibo5", display=display.none, active = isFibo5ToShow and is_enable_structfib_section)
string fibo5StyleOption = input.string("─", title = "", group=fibo_group, options=["─", "┈", "╌"], inline = "Fibo5", display=display.none, active = isFibo5ToShow and is_enable_structfib_section)
int fibo5LineWidth = input.int(1, title = "", group=fibo_group, minval=1, maxval=5, inline = "Fibo5", display=display.none, active = isFibo5ToShow and is_enable_structfib_section)

// ==========================================================================================
//                                 FVG GLOBAL VARIABLES
// ==========================================================================================
type Helper
    string name         = "Helper"

type FVG
    int tf_idx
    string tf
    string tf_label
    int tf_num
    box _box
    bool _type
    bool _isMitigated
    bool _isDrawn
    int left
    float top
    int right
    float bottom
    string extend=extend.none
    string border_style=line.style_solid
    int border_width=1
    color bgcolor
    color border_color
    string _text
    color text_color=color.white
    string text_halign=text.align_right
    string text_size

Helper helper = Helper.new()

method Validtimeframe(Helper helper, tf) =>
    helper.name := tf
    n1 = timeframe.in_seconds()
    n2 = timeframe.in_seconds(tf)
    n1 <= n2

// Arrays variable
var FVG[] fvgBox1 = array.new<FVG>()
var FVG[] fvgBox2 = array.new<FVG>()
var FVG[] fvgBox3 = array.new<FVG>()
var FVG[] fvgBox4 = array.new<FVG>()
var FVG[] fvgBox5 = array.new<FVG>()
var FVG[] fvgBox6 = array.new<FVG>()
var FVG[] fvgBox7 = array.new<FVG>()
var FVG[] fvgBox8 = array.new<FVG>()

getIsTFShow(int tf_idx) =>
    k = switch tf_idx
        0 => tf1_show
        1 => tf2_show
        2 => tf3_show
        3 => tf4_show
        4 => tf5_show
        5 => tf6_show
        6 => tf7_show
        7 => tf8_show

getTFLabel(int tf_idx) =>
    k = switch tf_idx
        0 => tf1_label
        1 => tf2_label
        2 => tf3_label
        3 => tf4_label
        4 => tf5_label
        5 => tf6_label
        6 => tf7_label
        7 => tf8_label

getTFMaxFVGs(int tf_idx) =>
    k = switch tf_idx
        0 => math.min(tf1_fvg_limit, fvgHistoryNbr)
        1 => math.min(tf2_fvg_limit, fvgHistoryNbr)
        2 => math.min(tf3_fvg_limit, fvgHistoryNbr)
        3 => math.min(tf4_fvg_limit, fvgHistoryNbr)
        4.  => math.min(tf5_fvg_limit, fvgHistoryNbr)
        5 => math.min(tf6_fvg_limit, fvgHistoryNbr)
        6 => math.min(tf7_fvg_limit, fvgHistoryNbr)
        7 => math.min(tf8_fvg_limit, fvgHistoryNbr)

// ==========================================================================================
//                                  FVG CORE FUNCTIONS
// ==========================================================================================

findFVGs (int tf_idx, string tf, string tf_label, int tf_num, FVG[] fvgBox) =>
    if (not ltf_hide or (ltf_hide and helper.Validtimeframe(tf)))
        [htf_high1, htf_low1, htf_high3, htf_low3, htf_time2] = request.security(syminfo.tickerid, tf, [high[1], low[1], high[3], low[3], time[2]], lookahead = barmerge.lookahead_on)
        isBullishFVG = htf_high3 < htf_low1
        isBearishFVG = htf_low3 > htf_high1

        // Bullish FVG process
        if isBullishFVG
            //find such FVG has already existed.
            bool isDuplicated=false
            for [ie, fvgE] in fvgBox
                if (fvgE.top==htf_low1) and (fvgE.bottom==htf_high3)
                    isDuplicated:=true

            if not isDuplicated
                // Add FVG into FVG's array
                FVG fvg1 = FVG.new(tf_idx, tf, tf_label, tf_num, na, true, false, false, left=bar_index - 2, top=htf_low1, right=0, bottom=htf_high3, extend = extend.none, border_style=line.style_solid, border_width=1, bgcolor=bullishFvgColor, border_color=color.new(color.green, 100), _text=tf_label, text_color=color.white, text_halign=text.align_right, text_size = label_size)
                fvgBox.push(fvg1)
                log.warning("added a BullFVG."+str.tostring(tf_idx))

                // Check if FVG to show is upper than user parameter
                if(fvgBox.size() > getTFMaxFVGs(tf_idx))
                    // Delete the FVG and its index from arrays
                    log.info("deleting BullFVG:"+str.tostring(fvgBox.size())+","+str.tostring(box.all.size()))
                    box b=fvgBox.get(0)._box
                    if not na(b)
                        box.delete(b)
                    fvgBox.remove(0)

        // Bearish FVG process
        if isBearishFVG
            //find such FVG has already existed.
            bool isDuplicated=false
            for [ie, fvgE] in fvgBox
                if (fvgE.top==htf_low3) and (fvgE.bottom==htf_high1)
                    isDuplicated:=true

            if not isDuplicated
                // Add FVG into FVG's array
                FVG fvg1 = FVG.new(tf_idx, tf, tf_label, tf_num, na, false, false, false, left=bar_index - 2, top=htf_low3, right=0, bottom=htf_high1, extend = extend.none, border_style=line.style_solid, border_width=1, bgcolor=bearishFvgColor, border_color=color.new(color.red, 100), _text=tf_label, text_color=color.white, text_halign=text.align_right, text_size = label_size)
                fvgBox.push(fvg1)
                log.warning("added a BearFVG."+str.tostring(tf_idx))

                // Check if FVG to show is upper than user parameter
                if(fvgBox.size() > getTFMaxFVGs(tf_idx))
                    // Delete the FVG and its index from arrays
                    log.info("deleting BearFVG:"+str.tostring(fvgBox.size())+","+str.tostring(box.all.size()))
                    box b=fvgBox.get(0)._box
                    if not na(b)
                        box.delete(b)
                    fvgBox.remove(0)

// Draw FVG
FVGDraw () =>
    for i1 = 0 to 7
        if (getIsTFShow(i1))
            FVG[] fvgBox = switch (i1)
                0 => fvgBox1
                1 => fvgBox2
                2 => fvgBox3
                3 => fvgBox4
                4 => fvgBox5
                5 => fvgBox6
                6 => fvgBox7
                7 => fvgBox8
            // Loop into all values of the array
            for [index, value] in fvgBox
                if (not value._isDrawn)
                    value._isDrawn:=true
                    // Processing FVG
                    value._box:=box.new(left=value.left, top=value.top, right=bar_index+value.tf_num*fvgTFDistance, bottom=value.bottom, extend = value.extend, border_style=value.border_style, border_width=value.border_width, bgcolor=value.bgcolor, border_color=value.border_color, text=value._text+(isAddBarIndex?str.tostring(bar_index):""), text_color=value.text_color, text_halign=value.text_halign, text_size = value.text_size)
                    log.warning("added a box, bar,bardist:"+str.tostring(bar_index)+","+str.tostring(value.tf_num*fvgTFDistance))
                
                if(value._type)
                    // Check if FVG has been totally mitigated
                    if(low <= box.get_bottom(value._box))
                        box.delete(value._box)
                        fvgBox.remove(index)
                        log.info("FVGDraw bullFVG removed.")
                    else
                        if(low < box.get_top((value._box)))
                            box.set_bgcolor(value._box, mitigatedFvgColor)
                           
                            // Mitigated FVG Alert
                            if(not(value._isMitigated))
                                alert("FVG has been mitigated", alert.freq_once_per_bar)
                                value._isMitigated:=true

                            // Reduce FVG if needed
                            if(isMitigatedFvgToReduce)
                                box.set_text(value._box, value.tf_label+"X")
                                box.set_text_formatting(value._box, text.format_italic)
                                box.set_top(value._box, low)

                        box.set_right(value._box, bar_index+ value.tf_num*fvgTFDistance)
                // Processing bearish FVG
                else
                    // Check if FVG has been mitigated
                    if(high >= box.get_top(value._box))
                        box.delete(value._box)
                        fvgBox.remove(index)
                        log.info("FVGDraw bearFVG removed.")
                    else
                        if(high > box.get_bottom(value._box))
                            box.set_bgcolor(value._box, mitigatedFvgColor)    

                            // Mitigated FVG Alert
                            if(not(value._isMitigated))
                                alert("FVG has been mitigated", alert.freq_once_per_bar)
                                value._isMitigated:=true

                            // Reduce FVG if needed
                            if(isMitigatedFvgToReduce)
                                box.set_text(value._box, value.tf_label+"X")
                                box.set_text_formatting(value._box, text.format_italic)
                                box.set_bottom(value._box, high)

                        box.set_right(value._box, bar_index+ value.tf_num*fvgTFDistance)

if is_enable_fvg_section
    int tf_num=0
    if tf8_show
        findFVGs(7, tf8, tf8_label, tf_num, fvgBox8)
        tf_num:=tf_num+1
    if tf7_show
        findFVGs(6, tf7, tf7_label, tf_num, fvgBox7)
        tf_num:=tf_num+1
    if tf6_show
        findFVGs(5, tf6, tf6_label, tf_num, fvgBox6)
        tf_num:=tf_num+1
    if tf5_show
        findFVGs(4, tf5, tf5_label, tf_num, fvgBox5)
        tf_num:=tf_num+1
    if tf4_show
        findFVGs(3, tf4, tf4_label, tf_num, fvgBox4)
        tf_num:=tf_num+1
    if tf3_show
        findFVGs(2, tf3, tf3_label, tf_num, fvgBox3)
        tf_num:=tf_num+1
    if tf2_show
        findFVGs(1, tf2, tf2_label, tf_num, fvgBox2)
        tf_num:=tf_num+1
    if tf1_show
        findFVGs(0, tf1, tf1_label, tf_num, fvgBox1)
        tf_num:=tf_num+1
    FVGDraw()

// ==========================================================================================
//                             STRUCTURES HELPER FUNCTIONS
// ==========================================================================================

get_structure_highest_bar(int lookback) =>
	var int idx = 0
    int maxBar1 = ta.highestbars(high, lookback)
    //int maxBar1B = 0
    int maxBar = bar_index > lookback ? maxBar1 : ta.highestbars(high, bar_index + 1)
	for i = 0 to lookback - 1 by 1
		if high[i+1] > high[i+2] and high[i] <= high[i+1] and ((i+1) * -1) >= maxBar
			idx := (i+1) * -1
	idx := idx == 0 ? maxBar : idx

get_structure_lowest_bar(int lookback) =>
	var int idx = 0
    int minBar1 = ta.lowestbars(low, lookback)
    //int minBar1B = 0
    int minBar = bar_index > lookback ? minBar1 : ta.lowestbars(low, bar_index + 1)
	for i = 0 to lookback - 1 by 1
		if low[i+1] < low[i+2] and low[i] >= low[i+1]  and ((i+1) * -1) >= minBar
			idx := (i+1) * -1
	idx := idx == 0 ? minBar : idx

// ==========================================================================================
//                             STRUCTURES GLOBAL VARIABLES
// ==========================================================================================
var structureLines = array.new_line(0)
var structureLabels = array.new_label(0)

// [已修改] 匹配 SMC.txt 的 0.0 初始化
var float structureHigh = 0.0
var float structureLow = 0.0

var int structureHighStartIndex = bar_index
var int structureLowStartIndex = bar_index
var int structureDirection = 0 // 0 = undefined, 1 = bearish, 2 = bullish
var line structureHighLine = na
var line structureLowLine = na
var bool isBOSAlert = false
var bool isCHOCHAlert = false
var line fibo1Line = na, var line fibo2Line = na, var line fibo3Line = na, var line fibo4Line = na, var line fibo5Line = na
var label fibo1Label = na, var label fibo2Label = na, var label fibo3Label = na, var label fibo4Label = na, var label fibo5Label = na

// [已修改] 声明通用的全局变量以避免所有报错
var float structureRange = na
var float fiboPrice = na
var int fiboStartIndex = na

// ==========================================================================================
//                                 MAIN SCRIPT LOGIC
// ==========================================================================================


//--------------------------------- Structures Processing ----------------------------------//
// Initialize value for bar 0
series float highestB10 = 0
series int highestBarB10 = 0
series float lowestB10 = 0
series int lowestBarB10 = 0
series float highestB10B = 0
series int highestBarB10B = 0
series float lowestB10B = 0
series int lowestBarB10B = 0
series float highest = 0
series int highestBar = 0
series float lowest = 0
series int lowestBar = 0

if is_enable_BosChoch_section
    highestB10 := ta.highest(10)
    highestBarB10 := ta.highestbars(high, 10)
    lowestB10 := ta.lowest(10)
    lowestBarB10 := ta.lowestbars(low, 10)
    highestB10B := ta.highest(bar_index + 1)
    highestBarB10B := ta.highestbars(high, bar_index + 1) 
    lowestB10B := ta.lowest(bar_index + 1)
    lowestBarB10B := ta.lowestbars(low, bar_index + 1)
    if(bar_index == 0)
        structureHighStartIndex := bar_index
        structureLowStartIndex  := bar_index
        structureHigh := high
        structureLow  := low 
    else if (bar_index > 10)
        highest := highestB10
        highestBar := highestBarB10
        lowest := lowestB10
        lowestBar := lowestBarB10
    else
        highest := highestB10B
        highestBar := highestBarB10B
        lowest := lowestB10B
        lowestBar := lowestBarB10B

    structureMaxBar = bar_index + get_structure_highest_bar(10)
    structureMinBar = bar_index + get_structure_lowest_bar(10)
    lowStructBreakPrice = isStructBodyCandleBreak ? close : low
    highStructBreakPrice = isStructBodyCandleBreak ? close : high
    isStuctureLowBroken = (lowStructBreakPrice < structureLow and lowStructBreakPrice[1] >= structureLow and lowStructBreakPrice[2] >= structureLow and lowStructBreakPrice[3] >= structureLow and bar_index[1] >  structureLowStartIndex and bar_index[2] >  structureLowStartIndex and bar_index[3] >  structureLowStartIndex) or (structureDirection == 2 and lowStructBreakPrice < structureLow)
    isStructureHighBroken = (highStructBreakPrice > structureHigh and highStructBreakPrice[1] <= structureHigh and highStructBreakPrice[2] <= structureHigh and highStructBreakPrice[3] <= structureHigh and bar_index[1] >  structureHighStartIndex and bar_index[2] >  structureHighStartIndex and bar_index[3] >  structureHighStartIndex) or (structureDirection == 1 and highStructBreakPrice > structureHigh)
    

    //if((low < structureLow and low[1] >= structureLow and low[2] >= structureLow and low[3] >= structureLow and bar_index[1] >  structureLowStartIndex and bar_index[2] >  structureLowStartIndex and bar_index[3] >  structureLowStartIndex) or (structureDirection == 2 and low < structureLow))
    if(isStuctureLowBroken)
        // Check if structures to show is upper than user parameter
        if(array.size(structureLines) >= structHistoryNbr)

            // [已修改] 内联 delete_line_and_label 函数以修复 v6 报错
            line line_to_delete = array.get(structureLines, 0)
            label label_to_delete = array.get(structureLabels, 0)
            if not na(line_to_delete)
                line_to_delete.delete()
            if not na(label_to_delete)
                label_to_delete.delete()
                
            array.remove(structureLabels, 0)
            array.remove(structureLines, 0)
            

        // Create BOS line
        if(structureDirection == 1)  
            array.push(structureLines, line.new(structureLowStartIndex, structureLow, bar_index, structureLow, xloc=xloc.bar_index, extend=extend.none, color=bearishBosColor, style=bosLineStyle, width=bosLineWidth))
            array.push(structureLabels, label.new((bar_index + structureLowStartIndex) / 2, structureLow, text="BOS", style=label.style_none, textcolor=bearishBosColor))
            isBOSAlert := true

        // Create CHoCH line
        else
            array.push(structureLines, line.new(structureLowStartIndex, structureLow, bar_index, structureLow, xloc=xloc.bar_index, extend=extend.none, color=bearishChochColor, style=chochLineStyle, width=chochLineWidth))
            array.push(structureLabels, label.new((bar_index + structureLowStartIndex) / 2, structureLow, text="CHoCH", style=label.style_none, textcolor=bearishChochColor))
            isCHOCHAlert := true

        // Update values for new structure 
        structureDirection := 1
        structureHighStartIndex := structureMaxBar
        structureLowStartIndex  := bar_index
        structureHigh :=  high[bar_index - structureHighStartIndex] //highest
        structureLow  := low

    // Check for breakout
    else if(isStructureHighBroken)
        
        // Check if structures to show is upper than user parameter
        if(array.size(structureLines) >= structHistoryNbr)

            // [已修改] 内联 delete_line_and_label 函数以修复 v6 报错
            line line_to_delete = array.get(structureLines, 0)
            label label_to_delete = array.get(structureLabels, 0)
            if not na(line_to_delete)
                line_to_delete.delete()
            if not na(label_to_delete)
                label_to_delete.delete()

            array.remove(structureLabels, 0)
            array.remove(structureLines, 0)

        // Create BOS line
        if(structureDirection == 2)  
            array.push(structureLines, line.new(structureHighStartIndex, structureHigh, bar_index, structureHigh, xloc=xloc.bar_index, extend=extend.none, color=bullishBosColor, style=bosLineStyle, width=bosLineWidth))
            array.push(structureLabels, label.new((bar_index + structureHighStartIndex) / 2, structureHigh, text="BOS", style=label.style_none, textcolor=bullishBosColor))
            isBOSAlert := true

        // Create CHoCH line
        else
            array.push(structureLines, line.new(structureHighStartIndex, structureHigh, bar_index, structureHigh, xloc=xloc.bar_index, extend=extend.none, color=bullishChochColor, style=chochLineStyle, width=chochLineWidth))
            array.push(structureLabels, label.new((bar_index + structureHighStartIndex) / 2, structureHigh, text="CHoCH", style=label.style_none, textcolor=bullishChochColor))
            isCHOCHAlert := true

        // Update values for new structure
        structureDirection := 2
        structureHighStartIndex := bar_index 
        structureLowStartIndex  := structureMinBar
        structureHigh := high 
        structureLow  := low[bar_index - structureLowStartIndex] //lowest
    else
        isBOSAlert := false
        isCHOCHAlert := false
        if(high > structureHigh and (structureDirection == 0 or structureDirection == 2))
            if(not(isStructBodyCandleBreak) or not(isStructBodyCandleBreak and bar_index[1] > structureHighStartIndex and bar_index[2] >  structureHighStartIndex and bar_index[3] > structureHighStartIndex))
                structureHigh := high
                structureHighStartIndex := bar_index
        else if(low < structureLow and (structureDirection == 0 or structureDirection == 1))
            if(not(isStructBodyCandleBreak) or not(isStructBodyCandleBreak and bar_index[1] > structureLowStartIndex and bar_index[2] > structureLowStartIndex and bar_index[3] > structureLowStartIndex))
                structureLow := low
                structureLowStartIndex := bar_index


if is_enable_currentstruct_section
    // [已修改] 内联 delete_line_and_label 函数
    if not na(structureHighLine)
        structureHighLine.delete()
    if not na(structureLowLine)
        structureLowLine.delete()

    structureHighStartIndex := math.max(structureHighStartIndex, bar_index - 4600)
    structureLowStartIndex := math.max(structureLowStartIndex, bar_index - 4600)
    if (structureHighStartIndex >= 0 and structureHighStartIndex <= bar_index)
        structureHighLine := line.new(structureHighStartIndex, structureHigh, bar_index, structureHigh, xloc.bar_index, color=currentStructColor, style = currentStructLineStyle, width = currentStructLineWidth)
    if (structureLowStartIndex >= 0 and structureLowStartIndex <= bar_index)
        structureLowLine := line.new(structureLowStartIndex, structureLow, bar_index, structureLow, xloc.bar_index, color=currentStructColor, style = currentStructLineStyle, width = currentStructLineWidth)

    // [已修改] 使用 := 赋值
    structureRange := math.abs(structureHigh - structureLow)

    if isFibo1ToShow and is_enable_structfib_section
        // [已修改] 内联 delete_line_and_label 函数
        if not na(fibo1Line)
            fibo1Line.delete()
        if not na(fibo1Label)
            fibo1Label.delete()
        // [已修改] 使用 SMC.txt 的斐波那契计算逻辑并使用 ":=" 赋值
        fiboPrice := structureDirection != 1 ? structureLow + (structureRange - structureRange * fibo1Value) : structureHigh - (structureRange - structureRange * fibo1Value)
        fiboStartIndex := structureDirection != 1 ? structureLowStartIndex : structureHighStartIndex
        fibo1Line := line.new(fiboStartIndex, fiboPrice, bar_index, fiboPrice, xloc.bar_index, color=fibo1Color, style=getLineStyle(fibo1StyleOption), width=fibo1LineWidth)
        fibo1Label := label.new(bar_index, fiboPrice, text=str.tostring(fibo1Value) + "(" + str.tostring(fiboPrice, format.mintick) + ")", style=label.style_none, textcolor=fibo1Color, xloc=xloc.bar_index, textalign=text.align_right)
    
    if isFibo2ToShow and is_enable_structfib_section
        // [已修改] 内联 delete_line_and_label 函数
        if not na(fibo2Line)
            fibo2Line.delete()
        if not na(fibo2Label)
            fibo2Label.delete()
        // [已修改] 使用 SMC.txt 的斐波那契计算逻辑并使用 ":=" 赋值
        fiboPrice := structureDirection != 1 ? structureLow + (structureRange - structureRange * fibo2Value) : structureHigh - (structureRange - structureRange * fibo2Value)
        fiboStartIndex := structureDirection != 1 ? structureLowStartIndex : structureHighStartIndex
        fibo2Line := line.new(fiboStartIndex, fiboPrice, bar_index, fiboPrice, xloc.bar_index, color=fibo2Color, style=getLineStyle(fibo2StyleOption), width=fibo2LineWidth)
        fibo2Label := label.new(bar_index, fiboPrice, text=str.tostring(fibo2Value) + "(" + str.tostring(fiboPrice, format.mintick) + ")", style=label.style_none, textcolor=fibo2Color, xloc=xloc.bar_index, textalign=text.align_right)
    
    if isFibo3ToShow and is_enable_structfib_section
        // [已修改] 内联 delete_line_and_label 函数
        if not na(fibo3Line)
            fibo3Line.delete()
        if not na(fibo3Label)
            fibo3Label.delete()
        // [已修改] 使用 SMC.txt 的斐波那契计算逻辑并使用 ":=" 赋值
        fiboPrice := structureDirection != 1 ? structureLow + (structureRange - structureRange * fibo3Value) : structureHigh - (structureRange - structureRange * fibo3Value)
        fiboStartIndex := structureDirection != 1 ? structureLowStartIndex : structureHighStartIndex
        fibo3Line := line.new(fiboStartIndex, fiboPrice, bar_index, fiboPrice, xloc.bar_index, color=fibo3Color, style=getLineStyle(fibo3StyleOption), width=fibo3LineWidth)
        fibo3Label := label.new(bar_index, fiboPrice, text=str.tostring(fibo3Value) + "(" + str.tostring(fiboPrice, format.mintick) + ")", style=label.style_none, textcolor=fibo3Color, xloc=xloc.bar_index, textalign=text.align_right)
    
    if isFibo4ToShow and is_enable_structfib_section
        // [已修改] 内联 delete_line_and_label 函数
        if not na(fibo4Line)
            fibo4Line.delete()
        if not na(fibo4Label)
            fibo4Label.delete()
        // [已修改] 使用 SMC.txt 的斐波那契计算逻辑并使用 ":=" 赋值
        fiboPrice := structureDirection != 1 ? structureLow + (structureRange - structureRange * fibo4Value) : structureHigh - (structureRange - structureRange * fibo4Value)
        fiboStartIndex := structureDirection != 1 ? structureLowStartIndex : structureHighStartIndex
        fibo4Line := line.new(fiboStartIndex, fiboPrice, bar_index, fiboPrice, xloc.bar_index, color=fibo4Color, style=getLineStyle(fibo4StyleOption), width=fibo4LineWidth)
        fibo4Label := label.new(bar_index, fiboPrice, text=str.tostring(fibo4Value) + "(" + str.tostring(fiboPrice, format.mintick) + ")", style=label.style_none, textcolor=fibo4Color, xloc=xloc.bar_index, textalign=text.align_right)
    
    if isFibo5ToShow and is_enable_structfib_section
        // [已修改] 内联 delete_line_and_label 函数
        if not na(fibo5Line)
            fibo5Line.delete()
        if not na(fibo5Label)
            fibo5Label.delete()
        // [已修改] 使用 SMC.txt 的斐波那契计算逻辑并使用 ":=" 赋值
        fiboPrice := structureDirection != 1 ? structureLow + (structureRange - structureRange * fibo5Value) : structureHigh - (structureRange - structureRange * fibo5Value)
        fiboStartIndex := structureDirection != 1 ? structureLowStartIndex : structureHighStartIndex
        fibo5Line := line.new(fiboStartIndex, fiboPrice, bar_index, fiboPrice, xloc.bar_index, color=fibo5Color, style=getLineStyle(fibo5StyleOption), width=fibo5LineWidth)
        fibo5Label := label.new(bar_index, fiboPrice, text=str.tostring(fibo5Value) + "(" + str.tostring(fiboPrice, format.mintick) + ")", style=label.style_none, textcolor=fibo5Color, xloc=xloc.bar_index, textalign=text.align_right)

alertcondition(condition = isBOSAlert, title = "BOS", message = "BOS occurred")
alertcondition(condition = isCHOCHAlert, title = "CHOCH", message = "CHOCH occurred")


//=========== MA PART============//


//************  Globals
// =====================================================================
// 1. COLOR PALETTES PER TEMPLATE (8 templates × 10 colors)
// =====================================================================
type colorSet
    color c1
    color c2
    color c3
    color c4
    color c5
    color c6
    color c7
    color c8
    color c9
    color c10

colorSet tplColors_1 = colorSet.new(#1565C0, #FF3232, #800080, color.white, color.yellow, color.green, #e17d9e, #40E0D0, #82FFC9, #00EEFF)  // EMA 20-50-100-200
colorSet tplColors_2 = colorSet.new(#1E88E5, #E53935, #8E24AA, #B0BEC5, #FFEB3B, #43A047, #F06292, #26C6DA, #81C784, #00E5FF)  // SMA 5-10-20-50-200
colorSet tplColors_3 = colorSet.new(#1976D2, #D32F2F, #7B1FA2, #F5F5F5, #FFEE58, #388E3C, #EC407A, #00BCD4, #66BB6A, #00B8D4)  // Fibonacci
colorSet tplColors_4 = colorSet.new(#1565C0, #E53935, #6A1B9A, color.white, #FFB300, #43A047, #F06292, #00ACC1, #81C784, #00B8D4)  // EMA/SMA Mix
colorSet tplColors_5 = colorSet.new(#1E88E5, #D32F2F, #8E24AA, #B0BEC5, #FFEB3B, #43A047, #F06292, #26C6DA, #81C784, #00E5FF)  // Golden EMA
colorSet tplColors_6 = colorSet.new(#1976D2, #C62828, #7B1FA2, #F5F5F5, #FFEE58, #388E3C, #EC407A, #00BCD4, #66BB6A, #00B8D4)  // Golden SMA
colorSet tplColors_7 = colorSet.new(#0288D1, #D50000, #9C27B0, #FAFAFA, #FFF176, #2E7D32, #E91E63, #00BFA5, #69F0AE, #00E676)  // HMA 21-34
colorSet tplColors_8 = colorSet.new(#0D47A1, #B71C1C, #4A148C, #EEEEEE, #FFCA28, #1B5E20, #AD1457, #006064, #1DE9B6, #00E5FF)  // The Crypto School Trading
//colorSet tplColors_default = colorSet.new(#0D47A1, #B71C1C, #4A148C, #EEEEEE, #FFCA28, #1B5E20, #AD1457, #006064, #1DE9B6, #00E5FF)  // Default

//********** Functions
// scale to the range of [min, max]
_funcMinMax(X, p, min, max) =>
    hi = ta.highest(X, p)
    lo = ta.lowest(X, p)
    (max - min) * (X - lo) / (hi - lo) + min

_funcLineStyle(_type) =>
    switch _type
        "Circles" => plot.style_circles
        "Stepline" => plot.style_stepline
        "Line With Breaks" => plot.style_linebr
        "Step Line With Diamonds" => plot.style_stepline_diamond
        =>
            plot.style_line

_funcSetFinalVal(_tpl, _type_1, _type_2, _type_3, _type_4, _type_5, _type_6, _type_7, _type_8, _maTypeDefault, _length_1, _length_2, _length_3, _length_4, _length_5, _length_6, _length_7, _length_8, _maLengthDefault) =>
    string _tmpMaType = _maTypeDefault
    int _tmpMaLength = _maLengthDefault
    if _tpl == 'EMA 20-50-100-200'
        _tmpMaType := _type_1
        _tmpMaLength := _length_1
        _tmpMaLength
    else if _tpl == 'SMA 5-10-20-50-200'
        _tmpMaType := _type_2
        _tmpMaLength := _length_2
        _tmpMaLength
    else if _tpl == 'EMA Fibonacci 21-55-89-144-233'
        _tmpMaType := _type_3
        _tmpMaLength := _length_3
        _tmpMaLength
    else if _tpl == 'EMA 20-50-100-200 / SMA 100-200'
        _tmpMaType := _type_4
        _tmpMaLength := _length_4
        _tmpMaLength
    else if _tpl == 'EMA Golden/Death Cross 50-200'
        _tmpMaType := _type_5
        _tmpMaLength := _length_5
        _tmpMaLength
    else if _tpl == 'SMA Golden/Death Cross 50-200'
        _tmpMaType := _type_6
        _tmpMaLength := _length_6
        _tmpMaLength
    else if _tpl == 'HMA Cross 21-34'
        _tmpMaType := _type_7
        _tmpMaLength := _length_7
        _tmpMaLength
    else if _tpl == 'The Crypto School Long Short Trading'
        _tmpMaType := _type_8
        _tmpMaLength := _length_8
        _tmpMaLength
    [_tmpMaType, _tmpMaLength]

// Chande Momentum Oscillator
_funcCMO(_src, _period) =>
    tmpMomentum = ta.change(_src)
    tmpSummaryUp = math.sum(math.max(tmpMomentum, 0), _period)
    tmpSummaryDown = math.sum(-math.min(tmpMomentum, 0), _period)
    math.abs((tmpSummaryUp - tmpSummaryDown) / (tmpSummaryUp + tmpSummaryDown))

// Triple EMA (TEMA)
_funcTEMA(_src, _period) =>
    ema1 = ta.ema(_src, _period)
    ema2 = ta.ema(ema1, _period)
    ema3 = ta.ema(ema2, _period)
    3 * (ema1 - ema2) + ema3

// Double Expotential Moving Average (DEMA)
_funcDEMA(_src, _period) =>
    2 * ta.ema(_src, _period) - ta.ema(ta.ema(_src, _period), _period)

// Exponential Hull Moving Average (EHMA)
_funcEHMA(_src, _period) =>
    tmpVal = math.max(2, _period)
    ta.ema(2 * ta.ema(_src, tmpVal / 2) - ta.ema(_src, tmpVal), math.round(math.sqrt(tmpVal)))

// Kaufman's Adaptive Moving Average (KAMA)
_funcKAMA(_src, _period) =>
    tmpVal = 0.0
    sum_1 = math.sum(math.abs(_src - _src[1]), _period)
    sum_2 = math.sum(math.abs(_src - _src[1]), _period)
    tmpVal := nz(tmpVal[1]) + math.pow((sum_1 != 0 ? math.abs(_src - _src[_period]) / sum_2 : 0) * (0.666 - 0.0645) + 0.0645, 2) * (_src - nz(tmpVal[1]))
    tmpVal

// Variable Index Dynamic Average (VIDYA)
_funcVIDYA(_src, _period) =>
    cmo = _funcCMO(_src, _period)
    alpha = 2 / (_period + 1)
    vidya = 0.0
    vidya := _src * alpha * cmo + nz(vidya[1]) * (1 - alpha * cmo)
    vidya

// Coefficient of Variation Weighted Moving Average (COVWMA)
_funcCOVWMA(_src, _period) =>
    _coefficientOfVariation = ta.stdev(_src, _period) / ta.sma(_src, _period)
    _cw = _src * _coefficientOfVariation
    math.sum(_cw, _period) / math.sum(_coefficientOfVariation, _period)

// Fractal Adaptive Moving Average (FRAMA)
_funcFRAMA(_src, _period) =>
    _coefficient = -4.6
    _n3 = (ta.highest(high, _period) - ta.lowest(low, _period)) / _period
    _hd2 = ta.highest(high, _period / 2)
    _ld2 = ta.lowest(low, _period / 2)
    _n2 = (_hd2 - _ld2) / (_period / 2)
    _n1 = (_hd2[_period / 2] - _ld2[_period / 2]) / (_period / 2)
    _dim = _n1 > 0 and _n2 > 0 and _n3 > 0 ? (math.log(_n1 + _n2) - math.log(_n3)) / math.log(2) : 0
    _alpha = math.exp(_coefficient * (_dim - 1))
    _sc = _alpha < 0.01 ? 0.01 : _alpha > 1 ? 1 : _alpha
    ta.cum(1) <= 2 * _period ? _src : _src * _sc + nz(_src[1]) * (1 - _sc)

// [已修复缩进错误 + Gaps]
// calculate the moving average with the transferred settings
_funcCalcMA(_type, _src, _timeframe, _period) =>
    float ma = switch _type
        "COVWMA" => _funcCOVWMA(_src, _period)
        "DEMA" => _funcDEMA(_src, _period)
        "EMA" => ta.ema(_src, _period)
        "EHMA" => _funcEHMA(_src, _period)
        "HMA" => ta.hma(_src, _period)
        "KAMA" => _funcKAMA(_src, _period)
        "SMA" => ta.sma(_src, _period) // <--- 修复了原始的缩进错误
        "SMMA (RMA)" => ta.rma(_src, _period)
        "TEMA" => _funcTEMA(_src, _period)
        "FRAMA" => _funcFRAMA(_src, _period)
        "VWMA" => ta.vwma(_src, _period)
        "VIDYA" => _funcVIDYA(_src, _period)
        "WMA" => ta.wma(_src, _period)
        =>
            float(na)
    // [关键修复] 添加 gaps=barmerge.gaps_on.
    // 这将使线条显示为阶梯状, 匹配 MA Ribbon 的行为
    request.security(syminfo.tickerid, _timeframe, ma, gaps = barmerge.gaps_on)

// =====================================================================
// 2. TEMPLATE MA SETTINGS (8 × 10) – Arrays
// =====================================================================
//********** Templates: settings

//----- EMA 20-50-100-200
string tpl_type1_1_MaType = 'EMA'
int tpl_type1_1_MaLength = 20
string tpl_type1_2_MaType = 'EMA'
int tpl_type1_2_MaLength = 50
string tpl_type1_3_MaType = 'EMA'
int tpl_type1_3_MaLength = 100
string tpl_type1_4_MaType = 'EMA'
int tpl_type1_4_MaLength = 200
string tpl_type1_5_MaType = 'DISABLED'
int tpl_type1_5_MaLength = 1
string tpl_type1_6_MaType = 'DISABLED'
int tpl_type1_6_MaLength = 1
string tpl_type1_7_MaType = 'DISABLED'
int tpl_type1_7_MaLength = 1
string tpl_type1_8_MaType = 'DISABLED'
int tpl_type1_8_MaLength = 1
string tpl_type1_9_MaType = 'DISABLED'
int tpl_type1_9_MaLength = 1
string tpl_type1_10_MaType = 'DISABLED'
int tpl_type1_10_MaLength = 1


//----- SMA 5-10-20-50-200
string tpl_type2_1_MaType = 'SMA'
int tpl_type2_1_MaLength = 5
string tpl_type2_2_MaType = 'SMA'
int tpl_type2_2_MaLength = 10
string tpl_type2_3_MaType = 'SMA'
int tpl_type2_3_MaLength = 20
string tpl_type2_4_MaType = 'SMA'
int tpl_type2_4_MaLength = 50
string tpl_type2_5_MaType = 'SMA'
int tpl_type2_5_MaLength = 200
string tpl_type2_6_MaType = 'DISABLED'
int tpl_type2_6_MaLength = 1
string tpl_type2_7_MaType = 'DISABLED'
int tpl_type2_7_MaLength = 1
string tpl_type2_8_MaType = 'DISABLED'
int tpl_type2_8_MaLength = 1
string tpl_type2_9_MaType = 'DISABLED'
int tpl_type2_9_MaLength = 1
string tpl_type2_10_MaType = 'DISABLED'
int tpl_type2_10_MaLength = 1


//----- EMA Fibonacci 21-55-89-144-233
// Fibonacci Sequences
// 0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610
string tpl_type3_1_MaType = 'EMA'
int tpl_type3_1_MaLength = 21
string tpl_type3_2_MaType = 'EMA'
int tpl_type3_2_MaLength = 55
string tpl_type3_3_MaType = 'EMA'
int tpl_type3_3_MaLength = 89
string tpl_type3_4_MaType = 'EMA'
int tpl_type3_4_MaLength = 144
string tpl_type3_5_MaType = 'EMA'
int tpl_type3_5_MaLength = 233
string tpl_type3_6_MaType = 'DISABLED'
int tpl_type3_6_MaLength = 1
string tpl_type3_7_MaType = 'DISABLED'
int tpl_type3_7_MaLength = 1
string tpl_type3_8_MaType = 'DISABLED'
int tpl_type3_8_MaLength = 1
string tpl_type3_9_MaType = 'DISABLED'
int tpl_type3_9_MaLength = 1
string tpl_type3_10_MaType = 'DISABLED'
int tpl_type3_10_MaLength = 1


//----- EMA 20-50-100-200 / SMA 100-200
string tpl_type4_1_MaType = 'EMA'
int tpl_type4_1_MaLength = 20
string tpl_type4_2_MaType = 'EMA'
int tpl_type4_2_MaLength = 50
string tpl_type4_3_MaType = 'EMA'
int tpl_type4_3_MaLength = 100
string tpl_type4_4_MaType = 'EMA'
int tpl_type4_4_MaLength = 200
string tpl_type4_5_MaType = 'SMA'
int tpl_type4_5_MaLength = 100
string tpl_type4_6_MaType = 'SMA'
int tpl_type4_6_MaLength = 100
string tpl_type4_7_MaType = 'DISABLED'
int tpl_type4_7_MaLength = 1
string tpl_type4_8_MaType = 'DISABLED'
int tpl_type4_8_MaLength = 1
string tpl_type4_9_MaType = 'DISABLED'
int tpl_type4_9_MaLength = 1
string tpl_type4_10_MaType = 'DISABLED'
int tpl_type4_10_MaLength = 1


//----- EMA Golden/Death Cross 50-200
string tpl_type5_1_MaType = 'EMA'
int tpl_type5_1_MaLength = 50
string tpl_type5_2_MaType = 'EMA'
int tpl_type5_2_MaLength = 200
string tpl_type5_3_MaType = 'DISABLED'
int tpl_type5_3_MaLength = 1
string tpl_type5_4_MaType = 'DISABLED'
int tpl_type5_4_MaLength = 1
string tpl_type5_5_MaType = 'DISABLED'
int tpl_type5_5_MaLength = 1
string tpl_type5_6_MaType = 'DISABLED'
int tpl_type5_6_MaLength = 1
string tpl_type5_7_MaType = 'DISABLED'
int tpl_type5_7_MaLength = 1
string tpl_type5_8_MaType = 'DISABLED'
int tpl_type5_8_MaLength = 1
string tpl_type5_9_MaType = 'DISABLED'
int tpl_type5_9_MaLength = 1
string tpl_type5_10_MaType = 'DISABLED'
int tpl_type5_10_MaLength = 1


//----- SMA Golden/Death Cross 50-200
string tpl_type6_1_MaType = 'SMA'
int tpl_type6_1_MaLength = 50
string tpl_type6_2_MaType = 'SMA'
int tpl_type6_2_MaLength = 200
string tpl_type6_3_MaType = 'DISABLED'
int tpl_type6_3_MaLength = 1
string tpl_type6_4_MaType = 'DISABLED'
int tpl_type6_4_MaLength = 1
string tpl_type6_5_MaType = 'DISABLED'
int tpl_type6_5_MaLength = 1
string tpl_type6_6_MaType = 'DISABLED'
int tpl_type6_6_MaLength = 1
string tpl_type6_7_MaType = 'DISABLED'
int tpl_type6_7_MaLength = 1
string tpl_type6_8_MaType = 'DISABLED'
int tpl_type6_8_MaLength = 1
string tpl_type6_9_MaType = 'DISABLED'
int tpl_type6_9_MaLength = 1
string tpl_type6_10_MaType = 'DISABLED'
int tpl_type6_10_MaLength = 1


//----- HMA Cross 21-34
string tpl_type7_1_MaType = 'HMA'
int tpl_type7_1_MaLength = 21
string tpl_type7_2_MaType = 'HMA'
int tpl_type7_2_MaLength = 34
string tpl_type7_3_MaType = 'DISABLED'
int tpl_type7_3_MaLength = 1
string tpl_type7_4_MaType = 'DISABLED'
int tpl_type7_4_MaLength = 1
string tpl_type7_5_MaType = 'DISABLED'
int tpl_type7_5_MaLength = 1
string tpl_type7_6_MaType = 'DISABLED'
int tpl_type7_6_MaLength = 1
string tpl_type7_7_MaType = 'DISABLED'
int tpl_type7_7_MaLength = 1
string tpl_type7_8_MaType = 'DISABLED'
int tpl_type7_8_MaLength = 1
string tpl_type7_9_MaType = 'DISABLED'
int tpl_type7_9_MaLength = 1
string tpl_type7_10_MaType = 'DISABLED'
int tpl_type7_10_MaLength = 1

 
//----- The Crypto School Long Short Trading
string tpl_type8_1_MaType = 'SMA'
int tpl_type8_1_MaLength = 21
string tpl_type8_2_MaType = 'SMA'
int tpl_type8_2_MaLength = 50
string tpl_type8_3_MaType = 'SMA'
int tpl_type8_3_MaLength = 200
string tpl_type8_4_MaType = 'EMA'
int tpl_type8_4_MaLength = 50
string tpl_type8_5_MaType = 'SMMA (RMA)'
int tpl_type8_5_MaLength = 7
string tpl_type8_6_MaType = 'SMMA (RMA)'
int tpl_type8_6_MaLength = 9
string tpl_type8_7_MaType = 'SMMA (RMA)'
int tpl_type8_7_MaLength = 99
string tpl_type8_8_MaType = 'SMA'
int tpl_type8_8_MaLength = 9
string tpl_type8_9_MaType = 'DISABLED'
int tpl_type8_9_MaLength = 1
string tpl_type8_10_MaType = 'DISABLED'
int tpl_type8_10_MaLength = 1


// =====================================================================
// 3. INPUTS
// =====================================================================

//************  set final settings
[valFinal_1_MaType, valFinal_1_MaLength] = _funcSetFinalVal(inputTemplate, tpl_type1_1_MaType, tpl_type2_1_MaType, tpl_type3_1_MaType, tpl_type4_1_MaType, tpl_type5_1_MaType, tpl_type6_1_MaType, tpl_type7_1_MaType, tpl_type8_1_MaType, input_1_MaType, tpl_type1_1_MaLength, tpl_type2_1_MaLength, tpl_type3_1_MaLength, tpl_type4_1_MaLength, tpl_type5_1_MaLength, tpl_type6_1_MaLength, tpl_type7_1_MaLength, tpl_type8_1_MaLength, input_1_MaLength)
[valFinal_2_MaType, valFinal_2_MaLength] = _funcSetFinalVal(inputTemplate, tpl_type1_2_MaType, tpl_type2_2_MaType, tpl_type3_2_MaType, tpl_type4_2_MaType, tpl_type5_2_MaType, tpl_type6_2_MaType, tpl_type7_2_MaType, tpl_type8_2_MaType, input_2_MaType, tpl_type1_2_MaLength, tpl_type2_2_MaLength, tpl_type3_2_MaLength, tpl_type4_2_MaLength, tpl_type5_2_MaLength, tpl_type6_2_MaLength, tpl_type7_2_MaLength, tpl_type8_2_MaLength, input_2_MaLength)
[valFinal_3_MaType, valFinal_3_MaLength] = _funcSetFinalVal(inputTemplate, tpl_type1_3_MaType, tpl_type2_3_MaType, tpl_type3_3_MaType, tpl_type4_3_MaType, tpl_type5_3_MaType, tpl_type6_3_MaType, tpl_type7_3_MaType, tpl_type8_3_MaType, input_3_MaType, tpl_type1_3_MaLength, tpl_type2_3_MaLength, tpl_type3_3_MaLength, tpl_type4_3_MaLength, tpl_type5_3_MaLength, tpl_type6_3_MaLength, tpl_type7_3_MaLength, tpl_type8_3_MaLength, input_3_MaLength)
[valFinal_4_MaType, valFinal_4_MaLength] = _funcSetFinalVal(inputTemplate, tpl_type1_4_MaType, tpl_type2_4_MaType, tpl_type3_4_MaType, tpl_type4_4_MaType, tpl_type5_4_MaType, tpl_type6_4_MaType, tpl_type7_4_MaType, tpl_type8_4_MaType, input_4_MaType, tpl_type1_4_MaLength, tpl_type2_4_MaLength, tpl_type3_4_MaLength, tpl_type4_4_MaLength, tpl_type5_4_MaLength, tpl_type6_4_MaLength, tpl_type7_4_MaLength, tpl_type8_4_MaLength, input_4_MaLength)
[valFinal_5_MaType, valFinal_5_MaLength] = _funcSetFinalVal(inputTemplate, tpl_type1_5_MaType, tpl_type2_5_MaType, tpl_type3_5_MaType, tpl_type4_5_MaType, tpl_type5_5_MaType, tpl_type6_5_MaType, tpl_type7_5_MaType, tpl_type8_5_MaType, input_5_MaType, tpl_type1_5_MaLength, tpl_type2_5_MaLength, tpl_type3_5_MaLength, tpl_type4_5_MaLength, tpl_type5_5_MaLength, tpl_type6_5_MaLength, tpl_type7_5_MaLength, tpl_type8_5_MaLength, input_5_MaLength)
[valFinal_6_MaType, valFinal_6_MaLength] = _funcSetFinalVal(inputTemplate, tpl_type1_6_MaType, tpl_type2_6_MaType, tpl_type3_6_MaType, tpl_type4_6_MaType, tpl_type5_6_MaType, tpl_type6_6_MaType, tpl_type7_6_MaType, tpl_type8_6_MaType, input_6_MaType, tpl_type1_6_MaLength, tpl_type2_6_MaLength, tpl_type3_6_MaLength, tpl_type4_6_MaLength, tpl_type5_6_MaLength, tpl_type6_6_MaLength, tpl_type7_6_MaLength, tpl_type8_6_MaLength, input_6_MaLength)
[valFinal_7_MaType, valFinal_7_MaLength] = _funcSetFinalVal(inputTemplate, tpl_type1_7_MaType, tpl_type2_7_MaType, tpl_type3_7_MaType, tpl_type4_7_MaType, tpl_type5_7_MaType, tpl_type6_7_MaType, tpl_type7_7_MaType, tpl_type8_7_MaType, input_7_MaType, tpl_type1_7_MaLength, tpl_type2_7_MaLength, tpl_type3_7_MaLength, tpl_type4_7_MaLength, tpl_type5_7_MaLength, tpl_type6_7_MaLength, tpl_type7_7_MaLength, tpl_type8_7_MaLength, input_7_MaLength)
[valFinal_8_MaType, valFinal_8_MaLength] = _funcSetFinalVal(inputTemplate, tpl_type1_8_MaType, tpl_type2_8_MaType, tpl_type3_8_MaType, tpl_type4_8_MaType, tpl_type5_8_MaType, tpl_type6_8_MaType, tpl_type7_8_MaType, tpl_type8_8_MaType, input_8_MaType, tpl_type1_8_MaLength, tpl_type2_8_MaLength, tpl_type3_8_MaLength, tpl_type4_8_MaLength, tpl_type5_8_MaLength, tpl_type6_8_MaLength, tpl_type7_8_MaLength, tpl_type8_8_MaLength, input_8_MaLength)
[valFinal_9_MaType, valFinal_9_MaLength] = _funcSetFinalVal(inputTemplate, tpl_type1_9_MaType, tpl_type2_9_MaType, tpl_type3_9_MaType, tpl_type4_9_MaType, tpl_type5_9_MaType, tpl_type6_9_MaType, tpl_type7_9_MaType, tpl_type8_9_MaType, input_9_MaType, tpl_type1_9_MaLength, tpl_type2_9_MaLength, tpl_type3_9_MaLength, tpl_type4_9_MaLength, tpl_type5_9_MaLength, tpl_type6_9_MaLength, tpl_type7_9_MaLength, tpl_type8_9_MaLength, input_9_MaLength)
[valFinal_10_MaType, valFinal_10_MaLength] = _funcSetFinalVal(inputTemplate, tpl_type1_10_MaType, tpl_type2_10_MaType, tpl_type3_10_MaType, tpl_type4_10_MaType, tpl_type5_10_MaType, tpl_type6_10_MaType, tpl_type7_10_MaType, tpl_type8_10_MaType, input_10_MaType, tpl_type1_10_MaLength, tpl_type2_10_MaLength, tpl_type3_10_MaLength, tpl_type4_10_MaLength, tpl_type5_10_MaLength, tpl_type6_10_MaLength, tpl_type7_10_MaLength, tpl_type8_10_MaLength, input_10_MaLength)

//************ Plotting
if inputTemplate!="DISABLED"
    input_1_Timeframe:=input_template_Timeframe
    input_2_Timeframe:=input_template_Timeframe
    input_3_Timeframe:=input_template_Timeframe
    input_4_Timeframe:=input_template_Timeframe
    input_5_Timeframe:=input_template_Timeframe
    input_6_Timeframe:=input_template_Timeframe
    input_7_Timeframe:=input_template_Timeframe
    input_8_Timeframe:=input_template_Timeframe
    input_9_Timeframe:=input_template_Timeframe
    input_10_Timeframe:=input_template_Timeframe

ma1= input_1_showMA ? _funcCalcMA(valFinal_1_MaType, input_1_Source, input_1_Timeframe, valFinal_1_MaLength): na 
ma2= input_2_showMA ? _funcCalcMA(valFinal_2_MaType, input_2_Source, input_2_Timeframe, valFinal_2_MaLength): na 
ma3= input_3_showMA ? _funcCalcMA(valFinal_3_MaType, input_3_Source, input_3_Timeframe, valFinal_3_MaLength): na 
ma4= input_4_showMA ? _funcCalcMA(valFinal_4_MaType, input_4_Source, input_4_Timeframe, valFinal_4_MaLength): na 
ma5= input_5_showMA ? _funcCalcMA(valFinal_5_MaType, input_5_Source, input_5_Timeframe, valFinal_5_MaLength): na 
ma6= input_6_showMA ? _funcCalcMA(valFinal_6_MaType, input_6_Source, input_6_Timeframe, valFinal_6_MaLength): na 
ma7= input_7_showMA ? _funcCalcMA(valFinal_7_MaType, input_7_Source, input_7_Timeframe, valFinal_7_MaLength): na 
ma8= input_8_showMA ? _funcCalcMA(valFinal_8_MaType, input_8_Source, input_8_Timeframe, valFinal_8_MaLength): na 
ma9= input_9_showMA ? _funcCalcMA(valFinal_9_MaType, input_9_Source, input_9_Timeframe, valFinal_9_MaLength): na 
ma10= input_10_showMA ? _funcCalcMA(valFinal_10_MaType, input_10_Source, input_10_Timeframe, valFinal_10_MaLength): na 

//ma1= _funcCalcMA(valFinal_1_MaType, input_1_Source, input_1_Timeframe, valFinal_1_MaLength)
//ma2= _funcCalcMA(valFinal_2_MaType, input_2_Source, input_2_Timeframe, valFinal_2_MaLength) 
//ma3= _funcCalcMA(valFinal_3_MaType, input_3_Source, input_3_Timeframe, valFinal_3_MaLength) 
//ma4= _funcCalcMA(valFinal_4_MaType, input_4_Source, input_4_Timeframe, valFinal_4_MaLength) 
//ma5= _funcCalcMA(valFinal_5_MaType, input_5_Source, input_5_Timeframe, valFinal_5_MaLength) 
//ma6= _funcCalcMA(valFinal_6_MaType, input_6_Source, input_6_Timeframe, valFinal_6_MaLength) 
//ma7= _funcCalcMA(valFinal_7_MaType, input_7_Source, input_7_Timeframe, valFinal_7_MaLength) 
//ma8= _funcCalcMA(valFinal_8_MaType, input_8_Source, input_8_Timeframe, valFinal_8_MaLength) 
//ma9= _funcCalcMA(valFinal_9_MaType, input_9_Source, input_9_Timeframe, valFinal_9_MaLength) 
//ma10= _funcCalcMA(valFinal_10_MaType, input_10_Source, input_10_Timeframe, valFinal_10_MaLength)


plot(ma1,  title='MA 1',  color=color.new(input_1_color, input_1_LineTransparency), linewidth=input_1_LineWidth, style=_funcLineStyle(input_1_LineStyle))
plot(ma2,  title='MA 2',  color=color.new(input_2_color, input_2_LineTransparency), linewidth=input_2_LineWidth, style=_funcLineStyle(input_2_LineStyle))
plot(ma3,  title='MA 3',  color=color.new(input_3_color, input_3_LineTransparency), linewidth=input_3_LineWidth, style=_funcLineStyle(input_3_LineStyle))
plot(ma4,  title='MA 4',  color=color.new(input_4_color, input_4_LineTransparency), linewidth=input_4_LineWidth, style=_funcLineStyle(input_4_LineStyle))
plot(ma5,  title='MA 5',  color=color.new(input_5_color, input_5_LineTransparency), linewidth=input_5_LineWidth, style=_funcLineStyle(input_5_LineStyle))
plot(ma6,  title='MA 6',  color=color.new(input_6_color, input_6_LineTransparency), linewidth=input_6_LineWidth, style=_funcLineStyle(input_6_LineStyle))
plot(ma7,  title='MA 7',  color=color.new(input_7_color, input_7_LineTransparency), linewidth=input_7_LineWidth, style=_funcLineStyle(input_7_LineStyle))
plot(ma8,  title='MA 8',  color=color.new(input_8_color, input_8_LineTransparency), linewidth=input_8_LineWidth, style=_funcLineStyle(input_8_LineStyle))
plot(ma9,  title='MA 9',  color=color.new(input_9_color, input_9_LineTransparency), linewidth=input_9_LineWidth, style=_funcLineStyle(input_9_LineStyle))
plot(ma10, title='MA 10', color=color.new(input_10_color, input_10_LineTransparency), linewidth=input_10_LineWidth, style=_funcLineStyle(input_10_LineStyle))

var label lbl1 = na
if input_1_showLabel and not na(ma1)
    label.delete(lbl1)
    lbl1 := label.new(bar_index, ma1, valFinal_1_MaType + " " + str.tostring(int(valFinal_1_MaLength)) + " " + f_timeframeToLabel(input_1_Timeframe), xloc.bar_index, yloc.price, color.new(input_1_color, input_curve_label_transp), label.style_label_left, input_curve_label_color, input_curve_label_size)

var label lbl2 = na
if input_2_showLabel and not na(ma2)
    label.delete(lbl2)
    lbl2 := label.new(bar_index, ma2, valFinal_2_MaType + " " + str.tostring(int(valFinal_2_MaLength)) + " " + f_timeframeToLabel(input_2_Timeframe), xloc.bar_index, yloc.price, color.new(input_2_color, input_curve_label_transp), label.style_label_left, input_curve_label_color, input_curve_label_size)

var label lbl3 = na
if input_3_showLabel and not na(ma3)
    label.delete(lbl3)
    lbl3 := label.new(bar_index, ma3, valFinal_3_MaType + " " + str.tostring(int(valFinal_3_MaLength)) + " " + f_timeframeToLabel(input_3_Timeframe), xloc.bar_index, yloc.price, color.new(input_3_color, input_curve_label_transp), label.style_label_left, input_curve_label_color, input_curve_label_size)

var label lbl4 = na
if input_4_showLabel and not na(ma4)
    label.delete(lbl4)
    lbl4 := label.new(bar_index, ma4, valFinal_4_MaType + " " + str.tostring(int(valFinal_4_MaLength)) + " " + f_timeframeToLabel(input_4_Timeframe), xloc.bar_index, yloc.price, color.new(input_4_color, input_curve_label_transp), label.style_label_left, input_curve_label_color, input_curve_label_size)

var label lbl5 = na
if input_5_showLabel and not na(ma5)
    label.delete(lbl5)
    lbl5 := label.new(bar_index, ma5, valFinal_5_MaType + " " + str.tostring(int(valFinal_5_MaLength)) + " " + f_timeframeToLabel(input_5_Timeframe), xloc.bar_index, yloc.price, color.new(input_5_color, input_curve_label_transp), label.style_label_left, input_curve_label_color, input_curve_label_size)

var label lbl6 = na
if input_6_showLabel and not na(ma6)
    label.delete(lbl6)
    lbl6 := label.new(bar_index, ma6, valFinal_6_MaType + " " + str.tostring(int(valFinal_6_MaLength)) + " " + f_timeframeToLabel(input_6_Timeframe), xloc.bar_index, yloc.price, color.new(input_6_color, input_curve_label_transp), label.style_label_left, input_curve_label_color, input_curve_label_size)

var label lbl7 = na
if input_7_showLabel and not na(ma7)
    label.delete(lbl7)
    lbl7 := label.new(bar_index, ma7, valFinal_7_MaType + " " + str.tostring(int(valFinal_7_MaLength)) + " " + f_timeframeToLabel(input_7_Timeframe), xloc.bar_index, yloc.price, color.new(input_7_color, input_curve_label_transp), label.style_label_left, input_curve_label_color, input_curve_label_size)

var label lbl8 = na
if input_8_showLabel and not na(ma8)
    label.delete(lbl8)
    lbl8 := label.new(bar_index, ma8, valFinal_8_MaType + " " + str.tostring(int(valFinal_8_MaLength)) + " " + f_timeframeToLabel(input_8_Timeframe), xloc.bar_index, yloc.price, color.new(input_8_color, input_curve_label_transp), label.style_label_left, input_curve_label_color, input_curve_label_size)

var label lbl9 = na
if input_9_showLabel and not na(ma9)
    label.delete(lbl9)
    lbl9 := label.new(bar_index, ma9, valFinal_9_MaType + " " + str.tostring(int(valFinal_9_MaLength)) + " " + f_timeframeToLabel(input_9_Timeframe), xloc.bar_index, yloc.price, color.new(input_9_color, input_curve_label_transp), label.style_label_left, input_curve_label_color, input_curve_label_size)

var label lbl10 = na
if input_10_showLabel and not na(ma10)
    label.delete(lbl10)
    lbl10 := label.new(bar_index, ma10, valFinal_10_MaType + " " + str.tostring(int(valFinal_10_MaLength)) + " " + f_timeframeToLabel(input_10_Timeframe), xloc.bar_index, yloc.price, color.new(input_10_color, input_curve_label_transp), label.style_label_left, input_curve_label_color, input_curve_label_size)

//-------------------------------------------------
//Auto Fib
//-------------------------------------------------
autoFibGroup = "Auto Fib Retracement"
devTooltip = "Deviation is a multiplier that affects how much the price should deviate from the previous pivot in order for the bar to become a new pivot."
depthTooltip = "The minimum number of bars that will be taken into account when calculating the indicator."

bool is_enable_autofib_section = input.bool(true, 'Enable Auto Fib Section', group=autoFibGroup, inline = "", display=display.none)
// pivots threshold
threshold_multiplier = input.float(title="Deviation", defval=3, minval=0, group=autoFibGroup, tooltip=devTooltip, active = is_enable_autofib_section)
depth = input.int(title="Depth", defval=10, minval=2, group=autoFibGroup, tooltip=depthTooltip, active = is_enable_autofib_section)
reverse = input(false, "Reverse", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
var extendLeft = input(false, "Extend Left    |    Extend Right", inline = "Extend Lines", group=autoFibGroup, active = is_enable_autofib_section)
var extendRight = input(true, "", inline = "Extend Lines", group=autoFibGroup, active = is_enable_autofib_section)
var extending = extend.none
if extendLeft and extendRight
    extending := extend.both
if extendLeft and not extendRight
    extending := extend.left
if not extendLeft and extendRight
    extending := extend.right
prices = input(true, "Show Prices", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
levels = input(true, "Show Levels", inline = "Levels", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
levelsFormat = input.string("Values", "", options = ["Values", "Percent"], inline = "Levels", display = display.data_window, group=autoFibGroup, active = levels and is_enable_autofib_section)
labelsPosition = input.string("Left", "Labels Position", options = ["Left", "Right"], display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
var int backgroundTransparency = input.int(85, "Background Transparency", minval = 0, maxval = 100, display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)

import TradingView/ZigZag/7 as zigzag
update()=>
    var zigzag.Pivot lastP1 = na
    var float startPrice1 = na
    var float height1 = na
    if is_enable_autofib_section
        var settings = zigzag.Settings.new(threshold_multiplier, depth, color(na), false, false, false, false, "Absolute", true)
        var zigzag.ZigZag zigZag = zigzag.newInstance(settings)
        if barstate.islast and zigZag.pivots.size() < 2
            runtime.error("Not enough data to calculate Auto Fib Retracement on the current symbol. Change the chart's timeframe to a lower one or select a smaller calculation depth using the indicator's `Depth` settings.")
        settings.devThreshold := ta.atr(10) / close * 100 * threshold_multiplier
        if zigZag.update()
            lastP1 := zigZag.lastPivot()
            if not na(lastP1)
                var line lineLast = na
                if na(lineLast)
                    lineLast := line.new(lastP1.start, lastP1.end, xloc=xloc.bar_time, color=color.gray, width=1, style=line.style_dashed)
                else
                    line.set_first_point(lineLast, lastP1.start)
                    line.set_second_point(lineLast, lastP1.end)

                startPrice1 := reverse ? lastP1.start.price : lastP1.end.price
                endPrice = reverse ? lastP1.end.price : lastP1.start.price
                height1 := (startPrice1 > endPrice ? -1 : 1) * math.abs(startPrice1 - endPrice)
    [lastP1, startPrice1, height1]

[lastP, startPrice, height] = update()

_draw_line(price, col) =>
    var id = line.new(lastP.start.time, lastP.start.price, time, price, xloc=xloc.bar_time, color=col, width=2, extend=extending)
    line.set_xy1(id, lastP.start.time, price)
    line.set_xy2(id, lastP.end.time, price)
    id

_draw_label(price, txt, txtColor) =>
    x = labelsPosition == "Left" ? lastP.start.time : not extendRight ? lastP.end.time : time
    labelStyle = labelsPosition == "Left" ? label.style_label_right : label.style_label_left
    align = labelsPosition == "Left" ? text.align_right : text.align_left
    labelsAlignStrLeft = txt + '\n ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏ \n'
    labelsAlignStrRight = '       ' + txt + '\n ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏ \n'
    labelsAlignStr = labelsPosition == "Left" ? labelsAlignStrLeft : labelsAlignStrRight
    var id = label.new(x=x, y=price, xloc=xloc.bar_time, text=labelsAlignStr, textcolor=txtColor, style=labelStyle, textalign=align, color=#00000000)
    label.set_xy(id, x, price)
    label.set_text(id, labelsAlignStr)
    label.set_textcolor(id, txtColor)

_wrap(txt) =>
    "(" + str.tostring(txt, format.mintick) + ")"

_label_txt(level, price) =>
    l = levelsFormat == "Values" ? str.tostring(level) : str.tostring(level * 100) + "%"
    (levels ? l : "") + (prices ? _wrap(price) : "")

_crossing_level(series float sr, series float r) =>
    (r > sr and r < sr[1]) or (r < sr and r > sr[1])

processLevel(bool show, float value, color colorL, line lineIdOther) =>
    float m = value
    r = startPrice + height * m
    crossed = _crossing_level(close, r)
    if show and not na(lastP)
        lineId = _draw_line(r, colorL)
        _draw_label(r, _label_txt(m, r), colorL)
        if crossed
            alert("Autofib: " + syminfo.ticker + " crossing level " + str.tostring(value))
        if not na(lineIdOther)
            linefill.new(lineId, lineIdOther, color = color.new(colorL, backgroundTransparency))
        lineId
    else
        lineIdOther


show_0  = input(true, "", inline = "Level0", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_0 = input(0, "", inline = "Level0", display = display.data_window, group=autoFibGroup, active = show_0 and is_enable_autofib_section)
color_0 = input(#787b86, "", inline = "Level0", display = display.data_window, group=autoFibGroup, active = show_0 and is_enable_autofib_section)

show_0_236  = input(true, "", inline = "Level0", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_0_236 = input(0.236, "", inline = "Level0", display = display.data_window, group=autoFibGroup, active = show_0_236 and is_enable_autofib_section)
color_0_236 = input(#f44336, "", inline = "Level0", display = display.data_window, group=autoFibGroup, active = show_0_236 and is_enable_autofib_section)

show_0_382  = input(true, "", inline = "Level1", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_0_382 = input(0.382, "", inline = "Level1", display = display.data_window, group=autoFibGroup, active = show_0_382 and is_enable_autofib_section)
color_0_382 = input(#81c784, "", inline = "Level1", display = display.data_window, group=autoFibGroup, active = show_0_382 and is_enable_autofib_section)

show_0_5  = input(true, "", inline = "Level1", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_0_5 = input(0.5, "", inline = "Level1", display = display.data_window, group=autoFibGroup, active = show_0_5 and is_enable_autofib_section)
color_0_5 = input(#4caf50, "", inline = "Level1", display = display.data_window, group=autoFibGroup, active = show_0_5 and is_enable_autofib_section)

show_0_618  = input(true, "", inline = "Level2", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_0_618 = input(0.618, "", inline = "Level2", display = display.data_window, group=autoFibGroup, active = show_0_618 and is_enable_autofib_section)
color_0_618 = input(#009688, "", inline = "Level2", display = display.data_window, group=autoFibGroup, active = show_0_618 and is_enable_autofib_section)

show_0_65  = input(false, "", inline = "Level2", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_0_65 = input(0.65, "", inline = "Level2", display = display.data_window, group=autoFibGroup, active = show_0_65 and is_enable_autofib_section)
color_0_65 = input(#009688, "", inline = "Level2", display = display.data_window, group=autoFibGroup, active = show_0_65 and is_enable_autofib_section)

show_0_786  = input(true, "", inline = "Level3", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_0_786 = input(0.786, "", inline = "Level3", display = display.data_window, group=autoFibGroup, active = show_0_786 and is_enable_autofib_section)
color_0_786 = input(#64b5f6, "", inline = "Level3", display = display.data_window, group=autoFibGroup, active = show_0_786 and is_enable_autofib_section)

show_1  = input(true, "", inline = "Level3", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_1 = input(1, "", inline = "Level3", display = display.data_window, group=autoFibGroup, active = show_1 and is_enable_autofib_section)
color_1 = input(#787b86, "", inline = "Level3", display = display.data_window, group=autoFibGroup, active = show_1 and is_enable_autofib_section)

show_1_272  = input(false, "", inline = "Level4", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_1_272 = input(1.272, "", inline = "Level4", display = display.data_window, group=autoFibGroup, active = show_1_272 and is_enable_autofib_section)
color_1_272 = input(#81c784, "", inline = "Level4", display = display.data_window, group=autoFibGroup, active = show_1_272 and is_enable_autofib_section)

show_1_414  = input(false, "", inline = "Level4", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_1_414 = input(1.414, "", inline = "Level4", display = display.data_window, group=autoFibGroup, active = show_1_414 and is_enable_autofib_section)
color_1_414 = input(#f44336, "", inline = "Level4", display = display.data_window, group=autoFibGroup, active = show_1_414 and is_enable_autofib_section)

show_1_618  = input(true, "", inline = "Level5", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_1_618 = input(1.618, "", inline = "Level5", display = display.data_window, group=autoFibGroup, active = show_1_618 and is_enable_autofib_section)
color_1_618 = input(#2962ff, "", inline = "Level5", display = display.data_window, group=autoFibGroup, active = show_1_618 and is_enable_autofib_section)

show_1_65  = input(false, "", inline = "Level5", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_1_65 = input(1.65, "", inline = "Level5", display = display.data_window, group=autoFibGroup, active = show_1_65 and is_enable_autofib_section)
color_1_65 = input(#2962ff, "", inline = "Level5", display = display.data_window, group=autoFibGroup, active = show_1_65 and is_enable_autofib_section)

show_2_618  = input(true, "", inline = "Level6", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_2_618 = input(2.618, "", inline = "Level6", display = display.data_window, group=autoFibGroup, active = show_2_618 and is_enable_autofib_section)
color_2_618 = input(#f44336, "", inline = "Level6", display = display.data_window, group=autoFibGroup, active = show_2_618 and is_enable_autofib_section)

show_2_65  = input(false, "", inline = "Level6", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_2_65 = input(2.65, "", inline = "Level6", display = display.data_window, group=autoFibGroup, active = show_2_65 and is_enable_autofib_section)
color_2_65 = input(#f44336, "", inline = "Level6", display = display.data_window, group=autoFibGroup, active = show_2_65 and is_enable_autofib_section)

show_3_618  = input(true, "", inline = "Level7", display = display.data_window, group=autoFibGroup, active = is_enable_autofib_section)
value_3_618 = input(3.618, "", inline = "Level7", display = display.data_window, group=autoFibGroup, active = show_3_618 and is_enable_autofib_section)
color_3_618 = input(#9c27b0, "", inline = "Level7", display = display.data_window, group=autoFibGroup, active = show_3_618 and is_enable_autofib_section)

show_3_65  = input(false, "", inline = "Level7", display = display.data_window, group = autoFibGroup, active = is_enable_autofib_section)
value_3_65 = input(3.65,  "", inline = "Level7", display = display.data_window, group = autoFibGroup, active = show_3_65 and is_enable_autofib_section)
color_3_65 = input(#9c27b0, "", inline = "Level7", display = display.data_window, group = autoFibGroup, active = show_3_65 and is_enable_autofib_section)

show_4_236  = input(true,  "", inline = "Level8", display = display.data_window, group = autoFibGroup, active = is_enable_autofib_section)
value_4_236 = input(4.236, "", inline = "Level8", display = display.data_window, group = autoFibGroup, active = show_4_236 and is_enable_autofib_section)
color_4_236 = input(#e91e63, "", inline = "Level8", display = display.data_window, group = autoFibGroup, active = show_4_236 and is_enable_autofib_section)

show_4_618  = input(false, "", inline = "Level8", display = display.data_window, group = autoFibGroup, active = is_enable_autofib_section)
value_4_618 = input(4.618, "", inline = "Level8", display = display.data_window, group = autoFibGroup, active = show_4_618 and is_enable_autofib_section)
color_4_618 = input(#81c784, "", inline = "Level8", display = display.data_window, group = autoFibGroup, active = show_4_618 and is_enable_autofib_section)

show_neg_0_236  = input(false, "", inline = "Level9", display = display.data_window, group = autoFibGroup, active = is_enable_autofib_section)
value_neg_0_236 = input(-0.236, "", inline = "Level9", display = display.data_window, group = autoFibGroup, active = show_neg_0_236 and is_enable_autofib_section)
color_neg_0_236 = input(#f44336, "", inline = "Level9", display = display.data_window, group = autoFibGroup, active = show_neg_0_236 and is_enable_autofib_section)

show_neg_0_382  = input(false, "", inline = "Level9", display = display.data_window, group = autoFibGroup, active = is_enable_autofib_section)
value_neg_0_382 = input(-0.382, "", inline = "Level9", display = display.data_window, group = autoFibGroup, active = show_neg_0_382 and is_enable_autofib_section)
color_neg_0_382 = input(#81c784, "", inline = "Level9", display = display.data_window, group = autoFibGroup, active = show_neg_0_382 and is_enable_autofib_section)

show_neg_0_618  = input(false, "", inline = "Level10", display = display.data_window, group = autoFibGroup, active = is_enable_autofib_section)
value_neg_0_618 = input(-0.618, "", inline = "Level10", display = display.data_window, group = autoFibGroup, active = show_neg_0_618 and is_enable_autofib_section)
color_neg_0_618 = input(#009688, "", inline = "Level10", display = display.data_window, group = autoFibGroup, active = show_neg_0_618 and is_enable_autofib_section)

show_neg_0_65  = input(false, "", inline = "Level10", display = display.data_window, group = autoFibGroup, active = is_enable_autofib_section)
value_neg_0_65 = input(-0.65,  "", inline = "Level10", display = display.data_window, group = autoFibGroup, active = show_neg_0_65 and is_enable_autofib_section)
color_neg_0_65 = input(#009688, "", inline = "Level10", display = display.data_window, group = autoFibGroup, active = show_neg_0_65 and is_enable_autofib_section)

if is_enable_autofib_section
    lineId0 = processLevel(show_neg_0_65, value_neg_0_65, color_neg_0_65, line(na))
    lineId1 = processLevel(show_neg_0_618, value_neg_0_618, color_neg_0_618, lineId0)
    lineId2 = processLevel(show_neg_0_382, value_neg_0_382, color_neg_0_382, lineId1)
    lineId3 = processLevel(show_neg_0_236, value_neg_0_236, color_neg_0_236, lineId2)
    lineId4 = processLevel(show_0, value_0, color_0, lineId3)
    lineId5 = processLevel(show_0_236, value_0_236, color_0_236, lineId4)
    lineId6 = processLevel(show_0_382, value_0_382, color_0_382, lineId5)
    lineId7 = processLevel(show_0_5, value_0_5, color_0_5, lineId6)
    lineId8 = processLevel(show_0_618, value_0_618, color_0_618, lineId7)
    lineId9 = processLevel(show_0_65, value_0_65, color_0_65, lineId8)
    lineId10 = processLevel(show_0_786, value_0_786, color_0_786, lineId9)
    lineId11 = processLevel(show_1, value_1, color_1, lineId10)
    lineId12 = processLevel(show_1_272, value_1_272, color_1_272, lineId11)
    lineId13 = processLevel(show_1_414, value_1_414, color_1_414, lineId12)
    lineId14 = processLevel(show_1_618, value_1_618, color_1_618, lineId13)
    lineId15 = processLevel(show_1_65, value_1_65, color_1_65, lineId14)
    lineId16 = processLevel(show_2_618, value_2_618, color_2_618, lineId15)
    lineId17 = processLevel(show_2_65, value_2_65, color_2_65, lineId16)
    lineId18 = processLevel(show_3_618, value_3_618, color_3_618, lineId17)
    lineId19 = processLevel(show_3_65, value_3_65, color_3_65, lineId18)
    lineId20 = processLevel(show_4_236, value_4_236, color_4_236, lineId19)
    lineId21 = processLevel(show_4_618, value_4_618, color_4_618, lineId20)
